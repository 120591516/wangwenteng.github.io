<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>离线安装 Kubernetes 1.18.3 版本 | 腾哥的学习笔记</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/img/favicon.ico">
    <link rel="stylesheet" href="/css/style.css">
    <script charset="utf-8" src="/js/custom.js"></script>
    <meta name="description" content="~~~学习过程中笔记心得整理~~~">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    <meta name="robots" content="all">
    <meta name="author" content="腾哥">
    
    <link rel="preload" href="/assets/css/0.styles.5e2bd223.css" as="style"><link rel="preload" href="/assets/js/app.d0f5f29d.js" as="script"><link rel="preload" href="/assets/js/4.14868eff.js" as="script"><link rel="preload" href="/assets/js/1.4ea549be.js" as="script"><link rel="preload" href="/assets/js/135.90f2f6ba.js" as="script"><link rel="preload" href="/assets/js/11.fc56e899.js" as="script"><link rel="prefetch" href="/assets/js/10.7e33cec6.js"><link rel="prefetch" href="/assets/js/100.2ceffe9b.js"><link rel="prefetch" href="/assets/js/101.215f4733.js"><link rel="prefetch" href="/assets/js/102.ca7bad8b.js"><link rel="prefetch" href="/assets/js/103.c8ee0685.js"><link rel="prefetch" href="/assets/js/104.4357f665.js"><link rel="prefetch" href="/assets/js/105.94bf8f3d.js"><link rel="prefetch" href="/assets/js/106.3cc23ee7.js"><link rel="prefetch" href="/assets/js/107.47cea753.js"><link rel="prefetch" href="/assets/js/108.f2776c21.js"><link rel="prefetch" href="/assets/js/109.eb3cbaf0.js"><link rel="prefetch" href="/assets/js/110.8e37f1b0.js"><link rel="prefetch" href="/assets/js/111.00e3895a.js"><link rel="prefetch" href="/assets/js/112.0d13e267.js"><link rel="prefetch" href="/assets/js/113.92d0d735.js"><link rel="prefetch" href="/assets/js/114.defa0132.js"><link rel="prefetch" href="/assets/js/115.e2302fd2.js"><link rel="prefetch" href="/assets/js/116.9aa31728.js"><link rel="prefetch" href="/assets/js/117.87da2967.js"><link rel="prefetch" href="/assets/js/118.0719b51f.js"><link rel="prefetch" href="/assets/js/119.06c7ffa7.js"><link rel="prefetch" href="/assets/js/12.3342f02c.js"><link rel="prefetch" href="/assets/js/120.16ea8844.js"><link rel="prefetch" href="/assets/js/121.1a210197.js"><link rel="prefetch" href="/assets/js/122.57af5232.js"><link rel="prefetch" href="/assets/js/123.f94dbe8c.js"><link rel="prefetch" href="/assets/js/124.befc3415.js"><link rel="prefetch" href="/assets/js/125.0cd9d026.js"><link rel="prefetch" href="/assets/js/126.1c4adbc3.js"><link rel="prefetch" href="/assets/js/127.2d5f561f.js"><link rel="prefetch" href="/assets/js/128.0e159bd8.js"><link rel="prefetch" href="/assets/js/129.1f20a0fe.js"><link rel="prefetch" href="/assets/js/13.c4c193ad.js"><link rel="prefetch" href="/assets/js/130.e5b27213.js"><link rel="prefetch" href="/assets/js/131.691920da.js"><link rel="prefetch" href="/assets/js/132.18e4f070.js"><link rel="prefetch" href="/assets/js/133.a47affc1.js"><link rel="prefetch" href="/assets/js/134.aa4e59cb.js"><link rel="prefetch" href="/assets/js/136.78d9ceeb.js"><link rel="prefetch" href="/assets/js/137.bfd1e3d7.js"><link rel="prefetch" href="/assets/js/138.bc50b459.js"><link rel="prefetch" href="/assets/js/14.f121e76c.js"><link rel="prefetch" href="/assets/js/15.7e24f77a.js"><link rel="prefetch" href="/assets/js/16.29826452.js"><link rel="prefetch" href="/assets/js/17.9f2de7e3.js"><link rel="prefetch" href="/assets/js/18.a4bf8745.js"><link rel="prefetch" href="/assets/js/19.52ec8030.js"><link rel="prefetch" href="/assets/js/20.c2f5e21c.js"><link rel="prefetch" href="/assets/js/21.f90f2277.js"><link rel="prefetch" href="/assets/js/22.ce3ccac6.js"><link rel="prefetch" href="/assets/js/23.f84d8665.js"><link rel="prefetch" href="/assets/js/24.51a2bb33.js"><link rel="prefetch" href="/assets/js/25.fe934725.js"><link rel="prefetch" href="/assets/js/26.76e97fb1.js"><link rel="prefetch" href="/assets/js/27.5cffabb7.js"><link rel="prefetch" href="/assets/js/28.c01fc035.js"><link rel="prefetch" href="/assets/js/29.05811075.js"><link rel="prefetch" href="/assets/js/30.8cf8db72.js"><link rel="prefetch" href="/assets/js/31.fe934437.js"><link rel="prefetch" href="/assets/js/32.4b432711.js"><link rel="prefetch" href="/assets/js/33.9f948ebe.js"><link rel="prefetch" href="/assets/js/34.64b2b6df.js"><link rel="prefetch" href="/assets/js/35.6e711aed.js"><link rel="prefetch" href="/assets/js/36.69e6ffc9.js"><link rel="prefetch" href="/assets/js/37.a1e81dbb.js"><link rel="prefetch" href="/assets/js/38.a82e2871.js"><link rel="prefetch" href="/assets/js/39.0988b65b.js"><link rel="prefetch" href="/assets/js/40.e8a2959a.js"><link rel="prefetch" href="/assets/js/41.61a206b6.js"><link rel="prefetch" href="/assets/js/42.a5afe9f7.js"><link rel="prefetch" href="/assets/js/43.76964262.js"><link rel="prefetch" href="/assets/js/44.74e54ebe.js"><link rel="prefetch" href="/assets/js/45.bf639ab1.js"><link rel="prefetch" href="/assets/js/46.aba8c4c7.js"><link rel="prefetch" href="/assets/js/47.90f06f6b.js"><link rel="prefetch" href="/assets/js/48.bb235e03.js"><link rel="prefetch" href="/assets/js/49.82b72272.js"><link rel="prefetch" href="/assets/js/5.b89c5eff.js"><link rel="prefetch" href="/assets/js/50.eaeea620.js"><link rel="prefetch" href="/assets/js/51.9ab10cc4.js"><link rel="prefetch" href="/assets/js/52.11bdc788.js"><link rel="prefetch" href="/assets/js/53.14c73295.js"><link rel="prefetch" href="/assets/js/54.ed63cd5a.js"><link rel="prefetch" href="/assets/js/55.94eec5f6.js"><link rel="prefetch" href="/assets/js/56.16828c9e.js"><link rel="prefetch" href="/assets/js/57.2cfa99da.js"><link rel="prefetch" href="/assets/js/58.0ae00a56.js"><link rel="prefetch" href="/assets/js/59.83f64a12.js"><link rel="prefetch" href="/assets/js/6.3e150692.js"><link rel="prefetch" href="/assets/js/60.4c927cc5.js"><link rel="prefetch" href="/assets/js/61.221015c1.js"><link rel="prefetch" href="/assets/js/62.6555c88d.js"><link rel="prefetch" href="/assets/js/63.da0a6c58.js"><link rel="prefetch" href="/assets/js/64.4b0661b6.js"><link rel="prefetch" href="/assets/js/65.e88b7527.js"><link rel="prefetch" href="/assets/js/66.f7f78321.js"><link rel="prefetch" href="/assets/js/67.704a1a20.js"><link rel="prefetch" href="/assets/js/68.b0a57510.js"><link rel="prefetch" href="/assets/js/69.11d75e96.js"><link rel="prefetch" href="/assets/js/7.5eb77440.js"><link rel="prefetch" href="/assets/js/70.616765fc.js"><link rel="prefetch" href="/assets/js/71.e4728e62.js"><link rel="prefetch" href="/assets/js/72.2f3c9ca8.js"><link rel="prefetch" href="/assets/js/73.e4d18df9.js"><link rel="prefetch" href="/assets/js/74.c3407851.js"><link rel="prefetch" href="/assets/js/75.b8775be6.js"><link rel="prefetch" href="/assets/js/76.f288ed34.js"><link rel="prefetch" href="/assets/js/77.63abcdf0.js"><link rel="prefetch" href="/assets/js/78.d6492f81.js"><link rel="prefetch" href="/assets/js/79.1c8fea21.js"><link rel="prefetch" href="/assets/js/8.3c5591af.js"><link rel="prefetch" href="/assets/js/80.431a7195.js"><link rel="prefetch" href="/assets/js/81.0b30cf22.js"><link rel="prefetch" href="/assets/js/82.2138d8f0.js"><link rel="prefetch" href="/assets/js/83.b9dad664.js"><link rel="prefetch" href="/assets/js/84.db6bd5f2.js"><link rel="prefetch" href="/assets/js/85.11cfcb2a.js"><link rel="prefetch" href="/assets/js/86.dd29a840.js"><link rel="prefetch" href="/assets/js/87.e195f6d1.js"><link rel="prefetch" href="/assets/js/88.bed58167.js"><link rel="prefetch" href="/assets/js/89.5ec20dd0.js"><link rel="prefetch" href="/assets/js/9.e6b7ce22.js"><link rel="prefetch" href="/assets/js/90.07dccf27.js"><link rel="prefetch" href="/assets/js/91.a6cec961.js"><link rel="prefetch" href="/assets/js/92.17d172f0.js"><link rel="prefetch" href="/assets/js/93.caf312e2.js"><link rel="prefetch" href="/assets/js/94.32bb8f70.js"><link rel="prefetch" href="/assets/js/95.aa681fef.js"><link rel="prefetch" href="/assets/js/96.aa5331f3.js"><link rel="prefetch" href="/assets/js/97.77b637d1.js"><link rel="prefetch" href="/assets/js/98.f81842bf.js"><link rel="prefetch" href="/assets/js/99.421ca433.js"><link rel="prefetch" href="/assets/js/vendors~flowchart.b584dfe5.js">
    <link rel="stylesheet" href="/assets/css/0.styles.5e2bd223.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div><div class="theme-container" data-v-4698c43e><div data-v-4698c43e><div id="loader-wrapper" class="loading-wrapper" data-v-1c4f0192 data-v-4698c43e data-v-4698c43e><div class="loader-main" data-v-1c4f0192><div data-v-1c4f0192></div><div data-v-1c4f0192></div><div data-v-1c4f0192></div><div data-v-1c4f0192></div></div> <!----> <!----></div> <div class="password-shadow password-wrapper-out" style="display:none;" data-v-6cbeab0a data-v-4698c43e data-v-4698c43e><h3 class="title" style="display:none;" data-v-6cbeab0a data-v-6cbeab0a>腾哥的学习笔记</h3> <!----> <label id="box" class="inputBox" style="display:none;" data-v-6cbeab0a data-v-6cbeab0a><input type="password" value="" data-v-6cbeab0a> <span data-v-6cbeab0a>Konck! Knock!</span> <button data-v-6cbeab0a>OK</button></label> <div class="footer" style="display:none;" data-v-6cbeab0a data-v-6cbeab0a><span data-v-6cbeab0a><i class="iconfont reco-theme" data-v-6cbeab0a></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-6cbeab0a>vuePress-theme-reco</a></span> <span data-v-6cbeab0a><i class="iconfont reco-copyright" data-v-6cbeab0a></i> <a data-v-6cbeab0a><span data-v-6cbeab0a>腾哥</span>
            
          <span data-v-6cbeab0a>2022 - </span>
          2022
        </a></span></div></div> <div class="hide" data-v-4698c43e><header class="navbar" data-v-4698c43e><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">腾哥的学习笔记</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/guide/" class="nav-link"><i class="iconfont reco-eye"></i>
  本站指南
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      分类
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/react/" class="nav-link"><i class="iconfont undefined"></i>
  react
</a></li><li class="dropdown-item"><!----> <a href="/categories/golang/" class="nav-link"><i class="iconfont undefined"></i>
  golang
</a></li><li class="dropdown-item"><!----> <a href="/categories/go语言介绍/" class="nav-link"><i class="iconfont undefined"></i>
  go语言介绍
</a></li><li class="dropdown-item"><!----> <a href="/categories/前端/" class="nav-link"><i class="iconfont undefined"></i>
  前端
</a></li><li class="dropdown-item"><!----> <a href="/categories/vue/" class="nav-link"><i class="iconfont undefined"></i>
  vue
</a></li><li class="dropdown-item"><!----> <a href="/categories/go web开发相关/" class="nav-link"><i class="iconfont undefined"></i>
  go web开发相关
</a></li><li class="dropdown-item"><!----> <a href="/categories/go语言基础/" class="nav-link"><i class="iconfont undefined"></i>
  go语言基础
</a></li><li class="dropdown-item"><!----> <a href="/categories/golang标准库/" class="nav-link"><i class="iconfont undefined"></i>
  golang标准库
</a></li><li class="dropdown-item"><!----> <a href="/categories/go语言标准库/" class="nav-link"><i class="iconfont undefined"></i>
  go语言标准库
</a></li><li class="dropdown-item"><!----> <a href="/categories/go单元测试/" class="nav-link"><i class="iconfont undefined"></i>
  go单元测试
</a></li><li class="dropdown-item"><!----> <a href="/categories/go 常用组件和技巧/" class="nav-link"><i class="iconfont undefined"></i>
  go 常用组件和技巧
</a></li><li class="dropdown-item"><!----> <a href="/categories/go 微服务/" class="nav-link"><i class="iconfont undefined"></i>
  go 微服务
</a></li><li class="dropdown-item"><!----> <a href="/categories/数据库相关/" class="nav-link"><i class="iconfont undefined"></i>
  数据库相关
</a></li><li class="dropdown-item"><!----> <a href="/categories/java/" class="nav-link"><i class="iconfont undefined"></i>
  java
</a></li><li class="dropdown-item"><!----> <a href="/categories/Java基础/" class="nav-link"><i class="iconfont undefined"></i>
  Java基础
</a></li><li class="dropdown-item"><!----> <a href="/categories/redis/" class="nav-link"><i class="iconfont undefined"></i>
  redis
</a></li><li class="dropdown-item"><!----> <a href="/categories/kuberbetes/" class="nav-link"><i class="iconfont undefined"></i>
  kuberbetes
</a></li><li class="dropdown-item"><!----> <a href="/categories/技术文章/" class="nav-link"><i class="iconfont undefined"></i>
  技术文章
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-sticky"></i>
      JAVA
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>Java</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/java/java/javase.html" class="nav-link"><i class="iconfont undefined"></i>
  JavaSE
</a></li><li class="dropdown-subitem"><a href="/java/java高级/javaee.html" class="nav-link"><i class="iconfont undefined"></i>
  JavaEE
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-document"></i>
      GoLang
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/golang/summary.html" class="nav-link"><i class="iconfont reco-category"></i>
  大纲
</a></li><li class="dropdown-item"><!----> <a href="/golang/go语言介绍/00summary.html" class="nav-link"><i class="iconfont reco-document"></i>
  介绍、搭建
</a></li><li class="dropdown-item"><!----> <a href="/golang/go语言基础/00summary.html" class="nav-link"><i class="iconfont reco-document"></i>
  基础
</a></li><li class="dropdown-item"><!----> <a href="/golang/go语言常用标准库/00summary.html" class="nav-link"><i class="iconfont reco-document"></i>
  标准库
</a></li><li class="dropdown-item"><!----> <a href="/golang/单元测试/00summary.html" class="nav-link"><i class="iconfont reco-document"></i>
  单元测试
</a></li><li class="dropdown-item"><!----> <a href="/golang/数据库相关/00summary.html" class="nav-link"><i class="iconfont reco-document"></i>
  数据库
</a></li><li class="dropdown-item"><!----> <a href="/golang/Web开发相关/00summary.html" class="nav-link"><i class="iconfont reco-document"></i>
  Web开发
</a></li><li class="dropdown-item"><!----> <a href="/golang/微服务相关/00summary.html" class="nav-link"><i class="iconfont reco-document"></i>
  微服务
</a></li><li class="dropdown-item"><!----> <a href="/golang/常用组件和技巧/00summary.html" class="nav-link"><i class="iconfont reco-document"></i>
  常用组件
</a></li><li class="dropdown-item"><!----> <a href="/golang/GORM教程/00summary.html" class="nav-link"><i class="iconfont reco-document"></i>
  GORM
</a></li><li class="dropdown-item"><!----> <a href="/golang/消息队列/00summary.html" class="nav-link"><i class="iconfont reco-document"></i>
  消息队列
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-document"></i>
      前端
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/front_end/summary.html" class="nav-link"><i class="iconfont reco-category"></i>
  大纲
</a></li><li class="dropdown-item"><!----> <a href="/front_end/vue/00summary.html" class="nav-link"><i class="iconfont reco-document"></i>
  vue
</a></li><li class="dropdown-item"><!----> <a href="/front_end/react/00summary.html" class="nav-link"><i class="iconfont reco-document"></i>
  react
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-api"></i>
      技术分享
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>docker</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/docker/" class="nav-link"><i class="iconfont undefined"></i>
  Go语言基础
</a></li></ul></li><li class="dropdown-item"><!----> <a href="/kubernetes/" class="nav-link router-link-active"><i class="iconfont reco-document"></i>
  kuberbetes
</a></li><li class="dropdown-item"><!----> <a href="/redis/" class="nav-link"><i class="iconfont reco-document"></i>
  redis
</a></li></ul></div></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  时间轴
</a></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-4698c43e></div> <aside class="sidebar" data-v-4698c43e><div class="personal-info-wrapper" data-v-6c8ffc9c><img src="/avatar.png" alt="author-avatar" class="personal-img" data-v-6c8ffc9c> <h3 class="name" data-v-6c8ffc9c>
    腾哥
  </h3> <div class="num" data-v-6c8ffc9c><div data-v-6c8ffc9c><h3 data-v-6c8ffc9c>123</h3> <h6 data-v-6c8ffc9c>文章</h6></div> <div data-v-6c8ffc9c><h3 data-v-6c8ffc9c>16</h3> <h6 data-v-6c8ffc9c>标签</h6></div></div> <hr data-v-6c8ffc9c></div> <nav class="nav-links"><div class="nav-item"><a href="/guide/" class="nav-link"><i class="iconfont reco-eye"></i>
  本站指南
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      分类
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/react/" class="nav-link"><i class="iconfont undefined"></i>
  react
</a></li><li class="dropdown-item"><!----> <a href="/categories/golang/" class="nav-link"><i class="iconfont undefined"></i>
  golang
</a></li><li class="dropdown-item"><!----> <a href="/categories/go语言介绍/" class="nav-link"><i class="iconfont undefined"></i>
  go语言介绍
</a></li><li class="dropdown-item"><!----> <a href="/categories/前端/" class="nav-link"><i class="iconfont undefined"></i>
  前端
</a></li><li class="dropdown-item"><!----> <a href="/categories/vue/" class="nav-link"><i class="iconfont undefined"></i>
  vue
</a></li><li class="dropdown-item"><!----> <a href="/categories/go web开发相关/" class="nav-link"><i class="iconfont undefined"></i>
  go web开发相关
</a></li><li class="dropdown-item"><!----> <a href="/categories/go语言基础/" class="nav-link"><i class="iconfont undefined"></i>
  go语言基础
</a></li><li class="dropdown-item"><!----> <a href="/categories/golang标准库/" class="nav-link"><i class="iconfont undefined"></i>
  golang标准库
</a></li><li class="dropdown-item"><!----> <a href="/categories/go语言标准库/" class="nav-link"><i class="iconfont undefined"></i>
  go语言标准库
</a></li><li class="dropdown-item"><!----> <a href="/categories/go单元测试/" class="nav-link"><i class="iconfont undefined"></i>
  go单元测试
</a></li><li class="dropdown-item"><!----> <a href="/categories/go 常用组件和技巧/" class="nav-link"><i class="iconfont undefined"></i>
  go 常用组件和技巧
</a></li><li class="dropdown-item"><!----> <a href="/categories/go 微服务/" class="nav-link"><i class="iconfont undefined"></i>
  go 微服务
</a></li><li class="dropdown-item"><!----> <a href="/categories/数据库相关/" class="nav-link"><i class="iconfont undefined"></i>
  数据库相关
</a></li><li class="dropdown-item"><!----> <a href="/categories/java/" class="nav-link"><i class="iconfont undefined"></i>
  java
</a></li><li class="dropdown-item"><!----> <a href="/categories/Java基础/" class="nav-link"><i class="iconfont undefined"></i>
  Java基础
</a></li><li class="dropdown-item"><!----> <a href="/categories/redis/" class="nav-link"><i class="iconfont undefined"></i>
  redis
</a></li><li class="dropdown-item"><!----> <a href="/categories/kuberbetes/" class="nav-link"><i class="iconfont undefined"></i>
  kuberbetes
</a></li><li class="dropdown-item"><!----> <a href="/categories/技术文章/" class="nav-link"><i class="iconfont undefined"></i>
  技术文章
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-sticky"></i>
      JAVA
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>Java</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/java/java/javase.html" class="nav-link"><i class="iconfont undefined"></i>
  JavaSE
</a></li><li class="dropdown-subitem"><a href="/java/java高级/javaee.html" class="nav-link"><i class="iconfont undefined"></i>
  JavaEE
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-document"></i>
      GoLang
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/golang/summary.html" class="nav-link"><i class="iconfont reco-category"></i>
  大纲
</a></li><li class="dropdown-item"><!----> <a href="/golang/go语言介绍/00summary.html" class="nav-link"><i class="iconfont reco-document"></i>
  介绍、搭建
</a></li><li class="dropdown-item"><!----> <a href="/golang/go语言基础/00summary.html" class="nav-link"><i class="iconfont reco-document"></i>
  基础
</a></li><li class="dropdown-item"><!----> <a href="/golang/go语言常用标准库/00summary.html" class="nav-link"><i class="iconfont reco-document"></i>
  标准库
</a></li><li class="dropdown-item"><!----> <a href="/golang/单元测试/00summary.html" class="nav-link"><i class="iconfont reco-document"></i>
  单元测试
</a></li><li class="dropdown-item"><!----> <a href="/golang/数据库相关/00summary.html" class="nav-link"><i class="iconfont reco-document"></i>
  数据库
</a></li><li class="dropdown-item"><!----> <a href="/golang/Web开发相关/00summary.html" class="nav-link"><i class="iconfont reco-document"></i>
  Web开发
</a></li><li class="dropdown-item"><!----> <a href="/golang/微服务相关/00summary.html" class="nav-link"><i class="iconfont reco-document"></i>
  微服务
</a></li><li class="dropdown-item"><!----> <a href="/golang/常用组件和技巧/00summary.html" class="nav-link"><i class="iconfont reco-document"></i>
  常用组件
</a></li><li class="dropdown-item"><!----> <a href="/golang/GORM教程/00summary.html" class="nav-link"><i class="iconfont reco-document"></i>
  GORM
</a></li><li class="dropdown-item"><!----> <a href="/golang/消息队列/00summary.html" class="nav-link"><i class="iconfont reco-document"></i>
  消息队列
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-document"></i>
      前端
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/front_end/summary.html" class="nav-link"><i class="iconfont reco-category"></i>
  大纲
</a></li><li class="dropdown-item"><!----> <a href="/front_end/vue/00summary.html" class="nav-link"><i class="iconfont reco-document"></i>
  vue
</a></li><li class="dropdown-item"><!----> <a href="/front_end/react/00summary.html" class="nav-link"><i class="iconfont reco-document"></i>
  react
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-api"></i>
      技术分享
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>docker</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/docker/" class="nav-link"><i class="iconfont undefined"></i>
  Go语言基础
</a></li></ul></li><li class="dropdown-item"><!----> <a href="/kubernetes/" class="nav-link router-link-active"><i class="iconfont reco-document"></i>
  kuberbetes
</a></li><li class="dropdown-item"><!----> <a href="/redis/" class="nav-link"><i class="iconfont reco-document"></i>
  redis
</a></li></ul></div></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  时间轴
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>kubernetes</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/kubernetes/Kubernetes_install.html" aria-current="page" class="active sidebar-link">离线安装 Kubernetes 1.18.3 版本</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/kubernetes/Kubernetes_install.html#一、kubernetes-简介" class="sidebar-link">一、Kubernetes 简介</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/kubernetes/Kubernetes_install.html#_1-kubernetes-架构设计图" class="sidebar-link">1.Kubernetes 架构设计图</a></li><li class="sidebar-sub-header"><a href="/kubernetes/Kubernetes_install.html#_2-kubernetes-常见组件介绍" class="sidebar-link">2.Kubernetes 常见组件介绍</a></li></ul></li><li class="sidebar-sub-header"><a href="/kubernetes/Kubernetes_install.html#二、kubernetes-二进制方式安装" class="sidebar-link">二、Kubernetes 二进制方式安装</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/kubernetes/Kubernetes_install.html#_1-创建-ca-证书和密钥" class="sidebar-link">1.创建 CA 证书和密钥</a></li><li class="sidebar-sub-header"><a href="/kubernetes/Kubernetes_install.html#_2-安装-etcd-组件" class="sidebar-link">2.安装 ETCD 组件</a></li><li class="sidebar-sub-header"><a href="/kubernetes/Kubernetes_install.html#_3-安装-flannel-网络插件" class="sidebar-link">3.安装 Flannel 网络插件</a></li><li class="sidebar-sub-header"><a href="/kubernetes/Kubernetes_install.html#_4-安装-docker-服务" class="sidebar-link">4.安装 Docker 服务</a></li><li class="sidebar-sub-header"><a href="/kubernetes/Kubernetes_install.html#_5-安装-kubectl-服务" class="sidebar-link">5.安装 Kubectl 服务</a></li></ul></li><li class="sidebar-sub-header"><a href="/kubernetes/Kubernetes_install.html#三、安装-kubenetes-相关组件" class="sidebar-link">三、安装 Kubenetes 相关组件</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/kubernetes/Kubernetes_install.html#_1-安装-kube-apiserver-组件" class="sidebar-link">1.安装 Kube-APIServer 组件</a></li><li class="sidebar-sub-header"><a href="/kubernetes/Kubernetes_install.html#_2-安装-controller-manager-组件" class="sidebar-link">2.安装 Controller Manager 组件</a></li><li class="sidebar-sub-header"><a href="/kubernetes/Kubernetes_install.html#_3-安装-kube-scheduler-组件" class="sidebar-link">3.安装 Kube-Scheduler 组件</a></li><li class="sidebar-sub-header"><a href="/kubernetes/Kubernetes_install.html#_4-安装-kubelet-组件" class="sidebar-link">4.安装 Kubelet 组件</a></li><li class="sidebar-sub-header"><a href="/kubernetes/Kubernetes_install.html#_5-安装-kube-proxy-组件" class="sidebar-link">5.安装 Kube-Proxy 组件</a></li><li class="sidebar-sub-header"><a href="/kubernetes/Kubernetes_install.html#_6-安装-coredns-插件" class="sidebar-link">6.安装 CoreDNS 插件</a></li><li class="sidebar-sub-header"><a href="/kubernetes/Kubernetes_install.html#_7-安装-dashboard-仪表盘" class="sidebar-link">7.安装 Dashboard 仪表盘</a></li></ul></li></ul></li><li><a href="/kubernetes/" aria-current="page" class="sidebar-link">kuberbetes 整理</a></li></ul></section></li></ul> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-6cbeab0a data-v-4698c43e><h3 class="title" style="display:none;" data-v-6cbeab0a data-v-6cbeab0a>离线安装 Kubernetes 1.18.3 版本</h3> <!----> <label id="box" class="inputBox" style="display:none;" data-v-6cbeab0a data-v-6cbeab0a><input type="password" value="" data-v-6cbeab0a> <span data-v-6cbeab0a>Konck! Knock!</span> <button data-v-6cbeab0a>OK</button></label> <div class="footer" style="display:none;" data-v-6cbeab0a data-v-6cbeab0a><span data-v-6cbeab0a><i class="iconfont reco-theme" data-v-6cbeab0a></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-6cbeab0a>vuePress-theme-reco</a></span> <span data-v-6cbeab0a><i class="iconfont reco-copyright" data-v-6cbeab0a></i> <a data-v-6cbeab0a><span data-v-6cbeab0a>腾哥</span>
            
          <span data-v-6cbeab0a>2022 - </span>
          2022
        </a></span></div></div> <div data-v-4698c43e><main class="page"><!----> <div class="page-title" style="display:none;"><h1>离线安装 Kubernetes 1.18.3 版本</h1> <hr> <div data-v-484a899e><i class="iconfont reco-account" data-v-484a899e><span data-v-484a899e>腾哥</span></i> <i class="iconfont reco-date" data-v-484a899e><span data-v-484a899e>2022-07-06 11:55:44</span></i> <!----> <i class="iconfont reco-tag tags" data-v-484a899e><span class="tag-item" data-v-484a899e>
      技术文章
    </span></i></div></div> <div class="theme-reco-content content__default" style="display:none;"><div class="custom-block danger"><p class="custom-block-title">说明</p> <p>离线安装 Kubernetes 1.18.3 版本</p></div> <h2 id="一、kubernetes-简介"><a href="#一、kubernetes-简介" class="header-anchor">#</a> 一、Kubernetes 简介</h2> <p>Kubernetes，也称为 K8s，是由 Google 公司开源的容器集群管理系统，在 Docker 技术的基础上，为容器化的应用提供部署运行、资源调度、服务发现和动态伸缩等一系列完整功能，提高了大规模容器集群管理的便捷性。Kubernetes 官方</p> <h3 id="_1-kubernetes-架构设计图"><a href="#_1-kubernetes-架构设计图" class="header-anchor">#</a> 1.Kubernetes 架构设计图</h3> <p>Kubernetes 是由一个 Master 和多个 Node 组成，Master 通过 API 提供服务，并接收 Kubectl 发送过来的请求来调度管理整个集群。</p> <p>Kubectl 是 K8s 平台的管理命令。
<img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h3x2emdsl8j20u00frgod.jpg" alt="图片"></p> <h3 id="_2-kubernetes-常见组件介绍"><a href="#_2-kubernetes-常见组件介绍" class="header-anchor">#</a> 2.Kubernetes 常见组件介绍</h3> <ul><li><strong>APIServer：</strong> 所有服务的统一访问入口，并提供认证、授权、访问控制、API 注册和发现等机制；</li> <li><strong>Controller Manager（控制器）：</strong> 主要就是用来维持 Pod 的一个副本数，比如故障检测、自动扩展、滚动更新等；</li> <li><strong>Scheduler（调度器）：</strong> 主要就是用来分配任务到合适的节点上（资源调度）</li> <li><strong>ETCD：</strong> 键值对数据库，存放了 K8s 集群中所有的重要信息（持久化）</li> <li><strong>Kubelet：</strong> 直接和容器引擎交互，用来维护容器的一个生命周期；同时也负责 Volume（CVI）和网络（CNI）的管理；</li> <li><strong>Kube-Porxy：</strong> 用于将规则写入至 iptables 或 IPVS 来实现服务的映射访问；</li></ul> <p><strong>其它组件：</strong></p> <ul><li>CoreDNS：主要就是用来给 K8s 的 Service 提供一个域名和 IP 的对应解析关系。</li> <li>Dashboard：主要就是用来给 K8s 提供一个 B/S 结构的访问体系（即，我们可以通过 Web 界面来对 K8s 进行管理）</li> <li>Ingress Controller：主要就是用来实现 HTTP 代理（七层），官方的 Service 仅支持 TCP\UDP 代理（四层）</li> <li>Prometheus：主要就是用来给 K8s 提供一个监控能力，使我们能够更加清晰的看到 K8s 相关组件及 Pod 的使用情况。</li> <li>ELK：主要就是用来给 K8s 提供一个日志分析平台。</li></ul> <p><strong>Kubernetes 工作原理：</strong></p> <ul><li>用户可以通过 Kubectl 命令来提交需要运行的 Docker Container 到 K8s 的 APIServer 组件中；</li> <li>接着 APIServer 接收到用户提交的请求后，会将请求存储到 ETCD 这个键值对存储中；</li> <li>然后由 Controller Manager 组件来创建出用户定义的控制器类型（Pod ReplicaSet Deployment DaemonSet 等）</li> <li>然后 Scheduler 组件会对 ETCD 进行扫描，并将用户需要运行的 Docker Container 分配到合适的主机上；</li> <li>最后由 Kubelet 组件来和 Docker 容器进行交互，创建、删除、停止容器等一系列操作。</li></ul> <p><code>kube-proxy</code> 主要就是为 Service 提供服务的，来实现内部从 Pod 到 Service 和外部 NodePort 到 Service 的访问。</p> <h2 id="二、kubernetes-二进制方式安装"><a href="#二、kubernetes-二进制方式安装" class="header-anchor">#</a> 二、Kubernetes 二进制方式安装</h2> <p>我们下面的安装方式就是单纯的使用二进制方式安装，并没有对 Kube-APIServer 组件进行高可用配置，因为像我们安装 K8s 的话，其实主要还是为了学习 K8s，通过 K8s 来完成某些事情，所以并不需要关心高可用这块的东西。</p> <p>要是对Kubernetes 做高可用的话，其实并不难，像一些在云上的 K8s，一般都是通过 SLB 来代理到两台不同服务器上，来实现高可用；而像云下的 K8s，基本上也是如上，我们可以通过 Keepalived 加 Nginx 来实现高可用。</p> <p>准备工作：</p> <table><thead><tr><th style="text-align:left;">主机名</th> <th style="text-align:left;">操作系统</th> <th style="text-align:left;">IP 地址</th> <th style="text-align:left;">所需组件</th></tr></thead> <tbody><tr><td style="text-align:left;"><code>k8s-master01</code></td> <td style="text-align:left;">CentOS 7.4</td> <td style="text-align:left;">192.168.1.1</td> <td style="text-align:left;">所有组件都安装 <strong>（合理利用资源）</strong></td></tr> <tr><td style="text-align:left;"><code>k8s-master02</code></td> <td style="text-align:left;">CentOS 7.4</td> <td style="text-align:left;">192.168.1.2</td> <td style="text-align:left;">所有组件都安装</td></tr> <tr><td style="text-align:left;"><code>k8s-node</code></td> <td style="text-align:left;">CentOS 7.4</td> <td style="text-align:left;">192.168.1.3</td> <td style="text-align:left;"><code>docker</code> <code>kubelet</code> <code>kube-proxy</code></td></tr></tbody></table> <p>1）在各个节点上配置主机名，并配置 Hosts 文件</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>[root@ddkk.com ~]# hostnamectl set-hostname k8s-master01
[root@ddkk.com ~]# bash
[root@k8s-master01 ~]# cat &lt;&lt;END &gt;&gt; /etc/hosts
192.168.1.1 k8s-master01
192.168.1.2 k8s-master02
192.168.1.3 k8s-node01
END
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>2）在<code>k8s-master01</code> 上配置 SSH 密钥对，并将公钥发送给其余主机</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>[root@k8s-master01 ~]# ssh-keygen -t rsa            # 三连回车
[root@k8s-master01 ~]# ssh-copy-id root@192.168.1.1
[root@k8s-master01 ~]# ssh-copy-id root@192.168.1.2
[root@k8s-master01 ~]# ssh-copy-id root@192.168.1.3
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>3）编写 K8s 初始环境脚本</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>[root@k8s-master01 ~]# vim k8s-init.sh
#!/bin/bash
#****************************************************************#
# ScriptName: k8s-init.sh
# Initialize the machine. This needs to be executed on every machine.
# Mkdir k8s directory
yum -y install wget ntpdate &amp;&amp; ntpdate ntp1.aliyun.com
wget -O /etc/yum.repos.d/CentOS-Base.repo https://mirrors.aliyun.com/repo/Centos-7.repo
yum -y install epel-release
mkdir -p /opt/k8s/bin/
mkdir -p /data/k8s/docker
mkdir -p /data/k8s/k8s
# Disable the SELinux.
swapoff -a
sed -i '/swap/s/^/#/' /etc/fstab
# Turn off and disable the firewalld.
systemctl stop firewalld
systemctl disable firewalld
# Modify related kernel parameters &amp; Disable the swap.
cat &gt; /etc/sysctl.d/k8s.conf &lt;&lt; EOF
net.ipv4.ip_forward = 1
net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables = 1
net.ipv4.tcp_tw_recycle = 0
vm.swappiness = 0
vm.overcommit_memory = 1
vm.panic_on_oom = 0
net.ipv6.conf.all.disable_ipv6 = 1
EOF
sysctl -p /etc/sysctl.d/k8s.conf &gt;&amp; /dev/null
# Add ipvs modules
cat &gt; /etc/sysconfig/modules/ipvs.modules &lt;&lt; EOF
#!/bin/bash
modprobe -- ip_vs
modprobe -- ip_vs_rr
modprobe -- ip_vs_wrr
modprobe -- ip_vs_sh
modprobe -- br_netfilter
modprobe -- nf_conntrack
modprobe -- nf_conntrack_ipv4
EOF
chmod 755 /etc/sysconfig/modules/ipvs.modules
source /etc/sysconfig/modules/ipvs.modules
# Install rpm
yum install -y conntrack ntpdate ntp ipvsadm ipset jq iptables curl sysstat libseccomp wget gcc gcc-c++ make libnl libnl-devel libnfnetlink-devel openssl-devel vim openssl-devel bash-completion
# ADD k8s bin to PATH
echo 'export PATH=/opt/k8s/bin:$PATH' &gt;&gt; /root/.bashrc &amp;&amp; chmod +x /root/.bashrc &amp;&amp; source /root/.bashrc
[root@k8s-master01 ~]# bash k8s-init.sh
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br></div></div><p>4）配置环境变量</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>[root@k8s-master01 ~]# vim environment.sh
#!/bin/bash
# 生成 EncryptionConfig 所需的加密 Key
export ENCRYPTION_KEY=$(head -c 32 /dev/urandom | base64)

# 集群 Master 机器 IP 数组
export MASTER_IPS=(192.168.1.1 192.168.1.2)

# 集群 Master IP 对应的主机名数组
export MASTER_NAMES=(k8s-master01 k8s-master02)

# 集群 Node 机器 IP 数组
export NODE_IPS=(192.168.1.3)

# 集群 Node IP 对应的主机名数组
export NODE_NAMES=(k8s-node01)

# 集群所有机器 IP 数组
export ALL_IPS=(192.168.1.1 192.168.1.2 192.168.1.3)

# 集群所有 IP 对应的主机名数组
export ALL_NAMES=(k8s-master01 k8s-master02 k8s-node01)

# Etcd 集群服务地址列表
export ETCD_ENDPOINTS=&quot;https://192.168.1.1:2379,https://192.168.1.2:2379&quot;

# Etcd 集群间通信的 IP 和端口
export ETCD_NODES=&quot;k8s-master01=https://192.168.1.1:2380,k8s-master02=https://192.168.1.2:2380&quot;

# Kube-apiserver 的 IP 和端口
export KUBE_APISERVER=&quot;https://192.168.1.1:6443&quot;

# 节点间互联网络接口名称
export IFACE=&quot;ens32&quot;

# Etcd 数据目录
export ETCD_DATA_DIR=&quot;/data/k8s/etcd/data&quot;

# Etcd WAL 目录. 建议是 SSD 磁盘分区. 或者和 ETCD_DATA_DIR 不同的磁盘分区
export ETCD_WAL_DIR=&quot;/data/k8s/etcd/wal&quot;

# K8s 各组件数据目录
export K8S_DIR=&quot;/data/k8s/k8s&quot;

# Docker 数据目录
export DOCKER_DIR=&quot;/data/k8s/docker&quot;

## 以下参数一般不需要修改
# TLS Bootstrapping 使用的 Token. 可以使用命令 head -c 16 /dev/urandom | od -An -t x | tr -d ' ' 生成
BOOTSTRAP_TOKEN=&quot;41f7e4ba8b7be874fcff18bf5cf41a7c&quot;

# 最好使用当前未用的网段来定义服务网段和 Pod 网段
# 服务网段. 部署前路由不可达. 部署后集群内路由可达(kube-proxy 保证)
SERVICE_CIDR=&quot;10.20.0.0/16&quot;

# Pod 网段. 建议 /16 段地址. 部署前路由不可达. 部署后集群内路由可达(flanneld 保证)
CLUSTER_CIDR=&quot;10.10.0.0/16&quot;

# 服务端口范围 (NodePort Range)
export NODE_PORT_RANGE=&quot;1-65535&quot;

# Flanneld 网络配置前缀
export FLANNEL_ETCD_PREFIX=&quot;/kubernetes/network&quot;

# Kubernetes 服务 IP (一般是 SERVICE_CIDR 中第一个 IP)
export CLUSTER_KUBERNETES_SVC_IP=&quot;10.20.0.1&quot;

# 集群 DNS 服务 IP (从 SERVICE_CIDR 中预分配)
export CLUSTER_DNS_SVC_IP=&quot;10.20.0.254&quot;

# 集群 DNS 域名(末尾不带点号)
export CLUSTER_DNS_DOMAIN=&quot;cluster.local&quot;

# 将二进制目录 /opt/k8s/bin 加到 PATH 中
export PATH=/opt/k8s/bin:$PATH
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br></div></div><ul><li>上面像那些 IP 地址和网卡啥的，你们要改成自身对应的信息。</li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code>[root@k8s-master01 ~]# chmod +x environment.sh &amp;&amp; source environment.sh
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>下面的这些操作，我们只需要在 <code>k8s-master01</code> 主机上操作即可（因为下面我们会通过 <code>for</code> 循环来发送到其余主机上）</p> <h3 id="_1-创建-ca-证书和密钥"><a href="#_1-创建-ca-证书和密钥" class="header-anchor">#</a> 1.创建 CA 证书和密钥</h3> <p>因为Kubernetes 系统的各个组件需要使用 TLS 证书对其通信加密以及授权认证，所以我们需要在安装前先生成相关的 TLS 证书；我们可以使用 <code>openssl</code> <code>cfssl</code> <code>easyrsa</code> 来生成 Kubernetes 的相关证书，我们下面使用的是 <code>cfssl</code> 方式。</p> <p>1）安装 <code>cfssl</code> 工具集</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>[root@k8s-master01 ~]# mkdir -p /opt/k8s/cert
[root@k8s-master01 ~]# curl -L https://pkg.cfssl.org/R1.2/cfssl_linux-amd64 -o /opt/k8s/bin/cfssl
[root@k8s-master01 ~]# curl -L https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64 -o /opt/k8s/bin/cfssljson
[root@k8s-master01 ~]# curl -L https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64 -o /opt/k8s/bin/cfssl-certinfo
[root@k8s-master01 ~]# chmod +x /opt/k8s/bin/*
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>2）创建根证书配置文件</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>[root@k8s-master01 ~]# mkdir -p /opt/k8s/work
[root@k8s-master01 ~]# cd /opt/k8s/work/
[root@k8s-master01 work]# cat &gt; ca-config.json &lt;&lt; EOF
{
   
     
    &quot;signing&quot;: {
   
     
        &quot;default&quot;: {
   
     
            &quot;expiry&quot;: &quot;876000h&quot;
        },
        &quot;profiles&quot;: {
   
     
            &quot;kubernetes&quot;: {
   
     
                &quot;expiry&quot;: &quot;876000h&quot;,
                &quot;usages&quot;: [
                    &quot;signing&quot;,
                    &quot;key encipherment&quot;,
                    &quot;server auth&quot;,
                    &quot;client auth&quot;
                ]
            }
        }
    }
}
EOF
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><ul><li>signing：表示当前证书可用于签名其它证书；</li> <li>server auth：表示 Client 可以用这个 CA 对 Server 提供的证书进行校验；</li> <li>client auth：表示 Server 可以用这个 CA 对 Client 提供的证书进行验证；</li> <li>&quot;expiry&quot;: &quot;876000h&quot;：表示当前证书有效期为 100 年；</li></ul> <p>3）创建根证书签名请求文件</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>[root@k8s-master01 work]# cat &gt; ca-csr.json &lt;&lt; EOF
{
   
     
    &quot;CN&quot;: &quot;kubernetes&quot;,
    &quot;key&quot;: {
   
     
        &quot;algo&quot;: &quot;rsa&quot;,
        &quot;size&quot;: 2048
    },
    &quot;names&quot;: [
        {
   
     
            &quot;C&quot;: &quot;CN&quot;,
            &quot;ST&quot;: &quot;Shanghai&quot;,
            &quot;L&quot;: &quot;Shanghai&quot;,
            &quot;O&quot;: &quot;k8s&quot;,
            &quot;OU&quot;: &quot;System&quot;
        }
    ],
    &quot;ca&quot;: {
   
     
        &quot;expiry&quot;: &quot;876000h&quot;
 }
}
EOF
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><ul><li>CN：Kube-APIServer 将会把这个字段作为请求的用户名，来让浏览器验证网站是否合法。</li> <li>C：<strong>国家</strong>；ST：<strong>州，省</strong>；L：<strong>地区，城市</strong>；O：<strong>组织名称，公司名称</strong>；OU：<strong>组织单位名称，公司部门。</strong></li></ul> <p>4）生成 CA 密钥 <code>ca-key.pem</code> 和证书 <code>ca.pem</code></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>[root@k8s-master01 work]# cfssl gencert -initca ca-csr.json | cfssljson -bare ca
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li>生成证书后，因为 Kubernetes 集群需要 <strong>双向 TLS 认证</strong>，所以我们可以将生成的文件传送到所有主机中。</li></ul> <p>5）使用 <code>for</code> 循环来遍历数组，将配置发送给所有主机</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>[root@k8s-master01 work]# for all_ip in ${
   
     ALL_IPS[@]}
  do
    echo &quot;&gt;&gt;&gt; ${all_ip}&quot;
    ssh root@${
   
     all_ip} &quot;mkdir -p /etc/kubernetes/cert&quot;
    scp ca*.pem ca-config.json root@${
   
     all_ip}:/etc/kubernetes/cert
  done
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h3 id="_2-安装-etcd-组件"><a href="#_2-安装-etcd-组件" class="header-anchor">#</a> 2.安装 ETCD 组件</h3> <p>ETCD 是基于 Raft 的分布式 <code>key-value</code> 存储系统，由 CoreOS 开发，常用于服务发现、共享配置以及并发控制（如 <code>leader</code> 选举、分布式锁等）；Kubernetes 主要就是用 ETCD 来存储所有的运行数据。</p> <p>下载ETCD</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>[root@k8s-master01 work]# wget https://github.com/etcd-io/etcd/releases/download/v3.3.22/etcd-v3.3.22-linux-amd64.tar.gz
[root@k8s-master01 work]# tar -zxf etcd-v3.3.22-linux-amd64.tar.gz
[root@k8s-master01 work]# for master_ip in ${
   
     MASTER_IPS[@]}
  do
    echo &quot;&gt;&gt;&gt; ${master_ip}&quot;
    scp etcd-v3.3.22-linux-amd64/etcd* root@${
   
     master_ip}:/opt/k8s/bin
    ssh root@${
   
     master_ip} &quot;chmod +x /opt/k8s/bin/*&quot;
  done
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h4 id="_1-创建-etcd-证书和密钥"><a href="#_1-创建-etcd-证书和密钥" class="header-anchor">#</a> 1）创建 ETCD 证书和密钥</h4> <div class="language- line-numbers-mode"><pre class="language-text"><code>[root@k8s-master01 work]# cat &gt; etcd-csr.json &lt;&lt; EOF
{
   
     
    &quot;CN&quot;: &quot;etcd&quot;,
    &quot;hosts&quot;: [
        &quot;127.0.0.1&quot;,
        &quot;192.168.1.1&quot;,
        &quot;192.168.1.2&quot;
  ],
    &quot;key&quot;: {
   
     
        &quot;algo&quot;: &quot;rsa&quot;,
        &quot;size&quot;: 2048
    },
    &quot;names&quot;: [
        {
   
     
            &quot;C&quot;: &quot;CN&quot;,
            &quot;ST&quot;: &quot;Shanghai&quot;,
            &quot;L&quot;: &quot;Shanghai&quot;,
            &quot;O&quot;: &quot;k8s&quot;,
            &quot;OU&quot;: &quot;System&quot;
        }
    ]
}
EOF
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><ul><li>hosts：用来指定给 ETCD 授权的 IP 地址或域名列表。</li></ul> <h4 id="_2-生成证书和密钥"><a href="#_2-生成证书和密钥" class="header-anchor">#</a> 2）生成证书和密钥</h4> <div class="language- line-numbers-mode"><pre class="language-text"><code>[root@k8s-master01 work]# cfssl gencert -ca=/opt/k8s/work/ca.pem -ca-key=/opt/k8s/work/ca-key.pem -config=/opt/k8s/work/ca-config.json -profile=kubernetes etcd-csr.json | cfssljson -bare etcd
[root@k8s-master01 work]# for master_ip in ${
   
     MASTER_IPS[@]}
  do
    echo &quot;&gt;&gt;&gt; ${master_ip}&quot;
    ssh root@${
   
     master_ip} &quot;mkdir -p /etc/etcd/cert&quot;
    scp etcd*.pem root@${
   
     master_ip}:/etc/etcd/cert/
  done
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h4 id="_3-创建启动脚本"><a href="#_3-创建启动脚本" class="header-anchor">#</a> 3）创建启动脚本</h4> <div class="language- line-numbers-mode"><pre class="language-text"><code>[root@k8s-master01 work]# cat &gt; etcd.service.template &lt;&lt; EOF
[Unit]
Description=Etcd Server
After=network.target
After=network-online.target
Wants=network-online.target
Documentation=https://github.com/coreos

[Service]
Type=notify
WorkingDirectory=${
   
     ETCD_DATA_DIR}
ExecStart=/opt/k8s/bin/etcd \\
  --enable-v2=true \\
  --data-dir=${
   
     ETCD_DATA_DIR} \\
  --wal-dir=${
   
     ETCD_WAL_DIR} \\
  --name=##MASTER_NAME## \\
  --cert-file=/etc/etcd/cert/etcd.pem \\
  --key-file=/etc/etcd/cert/etcd-key.pem \\
  --trusted-ca-file=/etc/kubernetes/cert/ca.pem \\
  --peer-cert-file=/etc/etcd/cert/etcd.pem \\
  --peer-key-file=/etc/etcd/cert/etcd-key.pem \\
  --peer-trusted-ca-file=/etc/kubernetes/cert/ca.pem \\
  --peer-client-cert-auth \\
  --client-cert-auth \\
  --listen-peer-urls=https://##MASTER_IP##:2380 \\
  --initial-advertise-peer-urls=https://##MASTER_IP##:2380 \\
  --listen-client-urls=https://##MASTER_IP##:2379,http://127.0.0.1:2379 \\
  --advertise-client-urls=https://##MASTER_IP##:2379 \\
  --initial-cluster-token=etcd-cluster-0 \\
  --initial-cluster=${
   
     ETCD_NODES} \\
  --initial-cluster-state=new \\
  --auto-compaction-mode=periodic \\
  --auto-compaction-retention=1 \\
  --max-request-bytes=33554432 \\
  --quota-backend-bytes=6442450944 \\
  --heartbeat-interval=250 \\
  --election-timeout=2000
Restart=on-failure
RestartSec=5
LimitNOFILE=65536

[Install]
WantedBy=multi-user.target
EOF
[root@k8s-master01 work]# for (( A=0; A &lt; 2; A++ ))
do
sed -e &quot;s/##MASTER_NAME##/${MASTER_NAMES[A]}/&quot; -e &quot;s/##MASTER_IP##/${MASTER_IPS[A]}/&quot; etcd.service.template &gt; etcd-${
   
     MASTER_IPS[A]}.service
done
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br></div></div><h4 id="_4-启动-etcd"><a href="#_4-启动-etcd" class="header-anchor">#</a> 4）启动 ETCD</h4> <div class="language- line-numbers-mode"><pre class="language-text"><code>[root@k8s-master01 work]# for master_ip in ${
   
     MASTER_IPS[@]}
  do
    echo &quot;&gt;&gt;&gt; ${master_ip}&quot;
    scp etcd-${
   
     master_ip}.service root@${
   
     master_ip}:/etc/systemd/system/etcd.service
    ssh root@${
   
     master_ip} &quot;mkdir -p ${ETCD_DATA_DIR} ${ETCD_WAL_DIR}&quot;
    ssh root@${
   
     master_ip} &quot;systemctl daemon-reload &amp;&amp; systemctl enable etcd &amp;&amp; systemctl restart etcd&quot;
  done
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>查看ETCD 当前的 Leader（领导）</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>[root@k8s-master01 work]# ETCDCTL_API=3 /opt/k8s/bin/etcdctl \
-w table --cacert=/etc/kubernetes/cert/ca.pem \
--cert=/etc/etcd/cert/etcd.pem \
--key=/etc/etcd/cert/etcd-key.pem \
--endpoints=${
   
     ETCD_ENDPOINTS} endpoint status
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h3x2ep9cikj20u008pgny.jpg" alt="图片"></p> <h3 id="_3-安装-flannel-网络插件"><a href="#_3-安装-flannel-网络插件" class="header-anchor">#</a> 3.安装 Flannel 网络插件</h3> <p>Flannel 是一种基于 <code>overlay</code> 网络的跨主机容器网络解决方案，也就是将 TCP 数据封装在另一种网络包里面进行路由转发和通信。Flannel 是使用 Go 语言开发的，主要就是用来让不同主机内的容器实现互联。</p> <p>下载Flannel</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>[root@k8s-master01 work]# mkdir flannel
[root@k8s-master01 work]# wget https://github.com/coreos/flannel/releases/download/v0.11.0/flannel-v0.11.0-linux-amd64.tar.gz
[root@k8s-master01 work]# tar -zxf flannel-v0.11.0-linux-amd64.tar.gz -C flannel
[root@k8s-master01 work]# for all_ip in ${
   
     ALL_IPS[@]}
  do
    echo &quot;&gt;&gt;&gt; ${all_ip}&quot;
    scp flannel/{
   
     flanneld,mk-docker-opts.sh} root@${
   
     all_ip}:/opt/k8s/bin/
    ssh root@${
   
     all_ip} &quot;chmod +x /opt/k8s/bin/*&quot;
  done
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><h4 id="_1-创建-flannel-证书和密钥"><a href="#_1-创建-flannel-证书和密钥" class="header-anchor">#</a> 1）创建 Flannel 证书和密钥</h4> <div class="language- line-numbers-mode"><pre class="language-text"><code>[root@k8s-master01 work]# cat &gt; flanneld-csr.json &lt;&lt; EOF
{
   
     
    &quot;CN&quot;: &quot;flanneld&quot;,
    &quot;hosts&quot;: [],
    &quot;key&quot;: {
   
     
        &quot;algo&quot;: &quot;rsa&quot;,
        &quot;size&quot;: 2048
    },
    &quot;names&quot;: [
        {
   
     
            &quot;C&quot;: &quot;CN&quot;,
            &quot;ST&quot;: &quot;Shanghai&quot;,
            &quot;L&quot;: &quot;Shanghai&quot;,
            &quot;O&quot;: &quot;k8s&quot;,
            &quot;OU&quot;: &quot;System&quot;
        }
    ]
}
EOF
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><h4 id="_2-生成证书和密钥-2"><a href="#_2-生成证书和密钥-2" class="header-anchor">#</a> 2）生成证书和密钥</h4> <div class="language- line-numbers-mode"><pre class="language-text"><code>[root@k8s-master01 work]# cfssl gencert -ca=/opt/k8s/work/ca.pem -ca-key=/opt/k8s/work/ca-key.pem -config=/opt/k8s/work/ca-config.json -profile=kubernetes flanneld-csr.json | cfssljson -bare flanneld
[root@k8s-master01 work]# for all_ip in ${
   
     ALL_IPS[@]}
  do
    echo &quot;&gt;&gt;&gt; ${all_ip}&quot;
    ssh root@${
   
     all_ip} &quot;mkdir -p /etc/flanneld/cert&quot;
    scp flanneld*.pem root@${
   
     all_ip}:/etc/flanneld/cert
  done
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>配置Pod 的网段信息</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>[root@k8s-master01 work]# etcdctl \
--endpoints=${
   
     ETCD_ENDPOINTS} \
--ca-file=/opt/k8s/work/ca.pem \
--cert-file=/opt/k8s/work/flanneld.pem \
--key-file=/opt/k8s/work/flanneld-key.pem \
mk ${
   
     FLANNEL_ETCD_PREFIX}/config '{&quot;Network&quot;:&quot;'${
   
     CLUSTER_CIDR}'&quot;, &quot;SubnetLen&quot;: 21, &quot;Backend&quot;: {&quot;Type&quot;: &quot;vxlan&quot;}}'
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p><img src="https://mmbiz.qpic.cn/mmbiz_png/GpcH5Yqqj0n9Cliag8kbwng634qNfmqFjgSlWmXFYz7wZrTadCyRJjFxr5yWYaBR77puPiceue5IOxhO3SEzcibIA/640?wx_fmt=png&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="图片"></p> <h4 id="_3-编写启动脚本"><a href="#_3-编写启动脚本" class="header-anchor">#</a> 3）编写启动脚本</h4> <div class="language- line-numbers-mode"><pre class="language-text"><code>[root@k8s-master01 work]# cat &gt; flanneld.service &lt;&lt; EOF
[Unit]
Description=Flanneld overlay address etcd agent
After=network.target
After=network-online.target
Wants=network-online.target
After=etcd.service
Before=docker.service

[Service]
Type=notify
ExecStart=/opt/k8s/bin/flanneld \\
  -etcd-cafile=/etc/kubernetes/cert/ca.pem \\
  -etcd-certfile=/etc/flanneld/cert/flanneld.pem \\
  -etcd-keyfile=/etc/flanneld/cert/flanneld-key.pem \\
  -etcd-endpoints=${
   
     ETCD_ENDPOINTS} \\
  -etcd-prefix=${
   
     FLANNEL_ETCD_PREFIX} \\
  -iface=${
   
     IFACE} \\
  -ip-masq
ExecStartPost=/opt/k8s/bin/mk-docker-opts.sh -k DOCKER_NETWORK_OPTIONS -d /run/flannel/docker
Restart=always
RestartSec=5
StartLimitInterval=0

[Install]
WantedBy=multi-user.target
RequiredBy=docker.service
EOF
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><h4 id="_4-启动并验证"><a href="#_4-启动并验证" class="header-anchor">#</a> 4）启动并验证</h4> <div class="language- line-numbers-mode"><pre class="language-text"><code>[root@k8s-master01 work]# for all_ip in ${
   
     ALL_IPS[@]}
  do
    echo &quot;&gt;&gt;&gt; ${all_ip}&quot;
    scp flanneld.service root@${
   
     all_ip}:/etc/systemd/system/
    ssh root@${
   
     all_ip} &quot;systemctl daemon-reload &amp;&amp; systemctl enable flanneld --now&quot;
  done
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>1）查看 Pod 网段信息</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>[root@k8s-master01 work]# etcdctl \
--endpoints=${
   
     ETCD_ENDPOINTS} \
--ca-file=/etc/kubernetes/cert/ca.pem \
--cert-file=/etc/flanneld/cert/flanneld.pem \
--key-file=/etc/flanneld/cert/flanneld-key.pem \
get ${
   
     FLANNEL_ETCD_PREFIX}/config
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h3x2esmtxbj20u009xwgb.jpg" alt="图片">
2）查看已分配的 Pod 子网段列表</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>[root@k8s-master01 work]# etcdctl \
--endpoints=${
   
     ETCD_ENDPOINTS} \
--ca-file=/etc/kubernetes/cert/ca.pem \
--cert-file=/etc/flanneld/cert/flanneld.pem \
--key-file=/etc/flanneld/cert/flanneld-key.pem \
ls ${
   
     FLANNEL_ETCD_PREFIX}/subnets
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h3x2et70g1j20u009wac4.jpg" alt="图片">
3）查看某一 Pod 网段对应的节点 IP 和 Flannel 接口地址</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>[root@k8s-master01 work]# etcdctl \
--endpoints=${
   
     ETCD_ENDPOINTS} \
--ca-file=/etc/kubernetes/cert/ca.pem \
--cert-file=/etc/flanneld/cert/flanneld.pem \
--key-file=/etc/flanneld/cert/flanneld-key.pem \
get ${
   
     FLANNEL_ETCD_PREFIX}/subnets/10.10.208.0-21
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h3x2eucpvsj20u009ujtd.jpg" alt="图片"></p> <h3 id="_4-安装-docker-服务"><a href="#_4-安装-docker-服务" class="header-anchor">#</a> 4.安装 Docker 服务</h3> <p>Docker 运行和管理容器，Kubelet 通过 Container Runtime Interface (CRI) 与它进行交互。</p> <p>下载Docker</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>[root@k8s-master01 work]# wget https://download.docker.com/linux/static/stable/x86_64/docker-19.03.12.tgz
[root@k8s-master01 work]# tar -zxf docker-19.03.12.tgz
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>安装Docker</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>[root@k8s-master01 work]# for all_ip in ${
   
     ALL_IPS[@]}
  do
    echo &quot;&gt;&gt;&gt; ${all_ip}&quot;
    scp docker/*  root@${
   
     all_ip}:/opt/k8s/bin/
    ssh root@${
   
     all_ip} &quot;chmod +x /opt/k8s/bin/*&quot;
  done
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h4 id="_1-创建启动脚本"><a href="#_1-创建启动脚本" class="header-anchor">#</a> 1）创建启动脚本</h4> <div class="language- line-numbers-mode"><pre class="language-text"><code>[root@k8s-master01 work]# cat &gt; docker.service &lt;&lt; &quot;EOF&quot;
[Unit]
Description=Docker Application Container Engine
Documentation=http://docs.docker.io

[Service]
WorkingDirectory=##DOCKER_DIR##
Environment=&quot;PATH=/opt/k8s/bin:/bin:/sbin:/usr/bin:/usr/sbin&quot;
EnvironmentFile=-/run/flannel/docker
ExecStart=/opt/k8s/bin/dockerd $DOCKER_NETWORK_OPTIONS
ExecReload=/bin/kill -s HUP $MAINPID
Restart=on-failure
RestartSec=5
LimitNOFILE=infinity
LimitNPROC=infinity
LimitCORE=infinity
Delegate=yes
KillMode=process

[Install]
WantedBy=multi-user.target
EOF
[root@k8s-master01 work]# sed -i -e &quot;s|##DOCKER_DIR##|${DOCKER_DIR}|&quot; docker.service
[root@k8s-master01 work]# for all_ip in ${
   
     ALL_IPS[@]}
  do
    echo &quot;&gt;&gt;&gt; ${all_ip}&quot;
    scp docker.service root@${
   
     all_ip}:/etc/systemd/system/
  done
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><p>配置<code>daemon.json</code> 文件</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>[root@k8s-master01 work]# cat &gt; daemon.json &lt;&lt; EOF
{
   
     
    &quot;registry-mirrors&quot;: [&quot;https://ipbtg5l0.mirror.aliyuncs.com&quot;],
    &quot;exec-opts&quot;: [&quot;native.cgroupdriver=cgroupfs&quot;],
    &quot;data-root&quot;: &quot;${DOCKER_DIR}/data&quot;,
    &quot;exec-root&quot;: &quot;${DOCKER_DIR}/exec&quot;,
    &quot;log-driver&quot;: &quot;json-file&quot;,
    &quot;log-opts&quot;: {
   
     
      &quot;max-size&quot;: &quot;100m&quot;,
      &quot;max-file&quot;: &quot;5&quot;
    },
    &quot;storage-driver&quot;: &quot;overlay2&quot;,
    &quot;storage-opts&quot;: [
      &quot;overlay2.override_kernel_check=true&quot;
  ]
}
EOF
[root@k8s-master01 work]# for all_ip in ${
   
     ALL_IPS[@]}
  do
    echo &quot;&gt;&gt;&gt; ${all_ip}&quot;
    ssh root@${
   
     all_ip} &quot;mkdir -p /etc/docker/ ${DOCKER_DIR}/{data,exec}&quot;
    scp daemon.json root@${
   
     all_ip}:/etc/docker/daemon.json
  done
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><h4 id="_2-启动-docker"><a href="#_2-启动-docker" class="header-anchor">#</a> 2）启动 Docker</h4> <div class="language- line-numbers-mode"><pre class="language-text"><code>[root@k8s-master01 work]# for all_ip in ${
   
     ALL_IPS[@]}
  do
    echo &quot;&gt;&gt;&gt; ${all_ip}&quot;
    ssh root@${
   
     all_ip} &quot;systemctl daemon-reload &amp;&amp; systemctl enable docker --now&quot;
  done
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h3 id="_5-安装-kubectl-服务"><a href="#_5-安装-kubectl-服务" class="header-anchor">#</a> 5.安装 Kubectl 服务</h3> <p>下载Kubectl</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>[root@k8s-master01 work]# wget https://storage.googleapis.com/kubernetes-release/release/v1.18.3/kubernetes-client-linux-amd64.tar.gz
[root@k8s-master01 work]# tar -zxf kubernetes-client-linux-amd64.tar.gz
[root@k8s-master01 work]# for master_ip in ${
   
     MASTER_IPS[@]}
  do
    echo &quot;&gt;&gt;&gt; ${master_ip}&quot;
    scp kubernetes/client/bin/kubectl root@${
   
     master_ip}:/opt/k8s/bin/
    ssh root@${
   
     master_ip} &quot;chmod +x /opt/k8s/bin/*&quot;
  done
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h4 id="_1-创建-admin-证书和密钥"><a href="#_1-创建-admin-证书和密钥" class="header-anchor">#</a> 1）创建 Admin 证书和密钥</h4> <div class="language- line-numbers-mode"><pre class="language-text"><code>[root@k8s-master01 work]# cat &gt; admin-csr.json &lt;&lt; EOF
{
   
     
    &quot;CN&quot;: &quot;admin&quot;,
    &quot;hosts&quot;: [],
    &quot;key&quot;: {
   
     
        &quot;algo&quot;: &quot;rsa&quot;,
        &quot;size&quot;: 2048
    },
    &quot;names&quot;: [
        {
   
     
            &quot;C&quot;: &quot;CN&quot;,
            &quot;ST&quot;: &quot;Shanghai&quot;,
            &quot;L&quot;: &quot;Shanghai&quot;,
            &quot;O&quot;: &quot;system:masters&quot;,
            &quot;OU&quot;: &quot;System&quot;
        }
    ]
}
EOF
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><h4 id="_3-生成证书和密钥"><a href="#_3-生成证书和密钥" class="header-anchor">#</a> 3）生成证书和密钥</h4> <div class="language- line-numbers-mode"><pre class="language-text"><code>[root@k8s-master01 work]# cfssl gencert -ca=/opt/k8s/work/ca.pem -ca-key=/opt/k8s/work/ca-key.pem -config=/opt/k8s/work/ca-config.json -profile=kubernetes admin-csr.json | cfssljson -bare admin
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="_4-创建-kubeconfig-文件"><a href="#_4-创建-kubeconfig-文件" class="header-anchor">#</a> 4）创建 Kubeconfig 文件</h4> <p>配置集群参数</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>[root@k8s-master01 work]# kubectl config set-cluster kubernetes \
--certificate-authority=/opt/k8s/work/ca.pem \
--embed-certs=true \
--server=${
   
     KUBE_APISERVER} \
--kubeconfig=kubectl.kubeconfig
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>配置客户端认证参数</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>[root@k8s-master01 work]# kubectl config set-credentials admin \
--client-certificate=/opt/k8s/work/admin.pem \
--client-key=/opt/k8s/work/admin-key.pem \
--embed-certs=true \
--kubeconfig=kubectl.kubeconfig
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>配置上下文参数</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>[root@k8s-master01 work]# kubectl config set-context kubernetes \
--cluster=kubernetes \
--user=admin \
--kubeconfig=kubectl.kubeconfig
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>配置默认上下文</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>[root@k8s-master01 work]## kubectl config use-context kubernetes --kubeconfig=kubectl.kubeconfig
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="_5-创建-kubectl-配置文件-并配置命令补全工具"><a href="#_5-创建-kubectl-配置文件-并配置命令补全工具" class="header-anchor">#</a> 5）创建 Kubectl 配置文件，并配置命令补全工具</h4> <div class="language- line-numbers-mode"><pre class="language-text"><code>[root@k8s-master01 work]## for master_ip in ${
   
     MASTER_IPS[@]}
  do
    echo &quot;&gt;&gt;&gt; ${master_ip}&quot;
    ssh root@${
   
     master_ip} &quot;mkdir -p ~/.kube&quot;
    scp kubectl.kubeconfig root@${
   
     master_ip}:~/.kube/config
    ssh root@${
   
     master_ip} &quot;echo 'export KUBECONFIG=\$HOME/.kube/config' &gt;&gt; ~/.bashrc&quot;
    ssh root@${
   
     master_ip} &quot;echo 'source &lt;(kubectl completion bash)' &gt;&gt; ~/.bashrc&quot;
  done
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>下面命令需要在 <code>k8s-master01</code> 和 <code>k8s-master02</code> 上配置：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>[root@k8s-master01 work]# source /usr/share/bash-completion/bash_completion
[root@k8s-master01 work]# source &lt;(kubectl completion bash)
[root@k8s-master01 work]# bash ~/.bashrc
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h2 id="三、安装-kubenetes-相关组件"><a href="#三、安装-kubenetes-相关组件" class="header-anchor">#</a> 三、安装 Kubenetes 相关组件</h2> <h3 id="_1-安装-kube-apiserver-组件"><a href="#_1-安装-kube-apiserver-组件" class="header-anchor">#</a> 1.安装 Kube-APIServer 组件</h3> <p>下载Kubernetes 二进制文件</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>[root@k8s-master01 work]# wget https://storage.googleapis.com/kubernetes-release/release/v1.18.3/kubernetes-server-linux-amd64.tar.gz
[root@k8s-master01 work]# tar -zxf kubernetes-server-linux-amd64.tar.gz
[root@k8s-master01 work]# cd kubernetes
[root@k8s-master01 kubernetes]# tar -zxf kubernetes-src.tar.gz
[root@k8s-master01 kubernetes]# cd ..
[root@k8s-master01 work]# for master_ip in ${
   
     MASTER_IPS[@]}
  do
    echo &quot;&gt;&gt;&gt; ${master_ip}&quot;
    scp -rp kubernetes/server/bin/{
   
     apiextensions-apiserver,kube-apiserver,kube-controller-manager,kube-scheduler,kubeadm,kubectl,mounter} root@${
   
     master_ip}:/opt/k8s/bin/
    ssh root@${
   
     master_ip} &quot;chmod +x /opt/k8s/bin/*&quot;
  done
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h4 id="_1-创建-kubernetes-证书和密钥"><a href="#_1-创建-kubernetes-证书和密钥" class="header-anchor">#</a> 1）创建 Kubernetes 证书和密钥</h4> <div class="language- line-numbers-mode"><pre class="language-text"><code>[root@k8s-master01 work]# cat &gt; kubernetes-csr.json &lt;&lt; EOF
{
   
     
  &quot;CN&quot;: &quot;kubernetes&quot;,
  &quot;hosts&quot;: [
    &quot;127.0.0.1&quot;,
    &quot;192.168.1.1&quot;,
    &quot;192.168.1.2&quot;,
    &quot;${CLUSTER_KUBERNETES_SVC_IP}&quot;,
    &quot;kubernetes&quot;,
    &quot;kubernetes.default&quot;,
    &quot;kubernetes.default.svc&quot;,
    &quot;kubernetes.default.svc.cluster&quot;,
    &quot;kubernetes.default.svc.cluster.local.&quot;
  ],
  &quot;key&quot;: {
   
     
    &quot;algo&quot;: &quot;rsa&quot;,
    &quot;size&quot;: 2048
  },
  &quot;names&quot;: [
    {
   
     
      &quot;C&quot;: &quot;CN&quot;,
      &quot;ST&quot;: &quot;Shanghai&quot;,
      &quot;L&quot;: &quot;Shanghai&quot;,
      &quot;O&quot;: &quot;k8s&quot;,
      &quot;OU&quot;: &quot;System&quot;
    }
  ]
}
EOF
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><h4 id="_2-生成证书和密钥-3"><a href="#_2-生成证书和密钥-3" class="header-anchor">#</a> 2）生成证书和密钥</h4> <div class="language- line-numbers-mode"><pre class="language-text"><code>[root@k8s-master01 work]# cfssl gencert -ca=/opt/k8s/work/ca.pem -ca-key=/opt/k8s/work/ca-key.pem -config=/opt/k8s/work/ca-config.json -profile=kubernetes kubernetes-csr.json | cfssljson -bare kubernetes
[root@k8s-master01 work]# for master_ip in ${
   
     MASTER_IPS[@]}
  do
    echo &quot;&gt;&gt;&gt; ${master_ip}&quot;
    ssh root@${
   
     master_ip} &quot;mkdir -p /etc/kubernetes/cert&quot;
    scp kubernetes*.pem root@${
   
     master_ip}:/etc/kubernetes/cert/
  done
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h4 id="_3-配置-kube-apiserver-审计"><a href="#_3-配置-kube-apiserver-审计" class="header-anchor">#</a> 3）配置 Kube-APIServer 审计</h4> <p>创建加密配置文件</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>[root@k8s-master01 work]# cat &gt; encryption-config.yaml &lt;&lt; EOF
kind: EncryptionConfig
apiVersion: v1
resources:
  - resources:
      - secrets
    providers:
      - aescbc:
          keys:
            - name: zhangsan
              secret: ${
   
     ENCRYPTION_KEY}
      - identity: {
   
     }
EOF
[root@k8s-master01 work]# for master_ip in ${
   
     MASTER_IPS[@]}
  do
    echo &quot;&gt;&gt;&gt; ${master_ip}&quot;
    scp encryption-config.yaml root@${
   
     master_ip}:/etc/kubernetes/encryption-config.yaml
  done
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>创建审计策略文件</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>[root@k8s-master01 work]# cat &gt; audit-policy.yaml &lt;&lt; EOF
apiVersion: audit.k8s.io/v1beta1
kind: Policy
rules:
  # The following requests were manually identified as high-volume and low-risk, so drop them.
  - level: None
    resources:
      - group: &quot;&quot;
        resources:
          - endpoints
          - services
          - services/status
    users:
      - 'system:kube-proxy'
    verbs:
      - watch

  - level: None
    resources:
      - group: &quot;&quot;
        resources:
          - nodes
          - nodes/status
    userGroups:
      - 'system:nodes'
    verbs:
      - get

  - level: None
    namespaces:
      - kube-system
    resources:
      - group: &quot;&quot;
        resources:
          - endpoints
    users:
      - 'system:kube-controller-manager'
      - 'system:kube-scheduler'
      - 'system:serviceaccount:kube-system:endpoint-controller'
    verbs:
      - get
      - update

  - level: None
    resources:
      - group: &quot;&quot;
        resources:
          - namespaces
          - namespaces/status
          - namespaces/finalize
    users:
      - 'system:apiserver'
    verbs:
      - get

  # Don't log HPA fetching metrics.
  - level: None
    resources:
      - group: metrics.k8s.io
    users:
      - 'system:kube-controller-manager'
    verbs:
      - get
      - list

  # Don't log these read-only URLs.
  - level: None
    nonResourceURLs:
      - '/healthz*'
      - /version
      - '/swagger*'

  # Don't log events requests.
  - level: None
    resources:
      - group: &quot;&quot;
        resources:
          - events

  # node and pod status calls from nodes are high-volume and can be large, don't log responses for expected updates from nodes
  - level: Request
    omitStages:
      - RequestReceived
    resources:
      - group: &quot;&quot;
        resources:
          - nodes/status
          - pods/status
    users:
      - kubelet
      - 'system:node-problem-detector'
      - 'system:serviceaccount:kube-system:node-problem-detector'
    verbs:
      - update
      - patch

  - level: Request
    omitStages:
      - RequestReceived
    resources:
      - group: &quot;&quot;
        resources:
          - nodes/status
          - pods/status
    userGroups:
      - 'system:nodes'
    verbs:
      - update
      - patch

  # deletecollection calls can be large, don't log responses for expected namespace deletions
  - level: Request
    omitStages:
      - RequestReceived
    users:
      - 'system:serviceaccount:kube-system:namespace-controller'
    verbs:
      - deletecollection

  # Secrets, ConfigMaps, and TokenReviews can contain sensitive &amp; binary data,
  # so only log at the Metadata level.
  - level: Metadata
    omitStages:
      - RequestReceived
    resources:
      - group: &quot;&quot;
        resources:
          - secrets
          - configmaps
      - group: authentication.k8s.io
        resources:
          - tokenreviews
  # Get repsonses can be large; skip them.
  - level: Request
    omitStages:
      - RequestReceived
    resources:
      - group: &quot;&quot;
      - group: admissionregistration.k8s.io
      - group: apiextensions.k8s.io
      - group: apiregistration.k8s.io
      - group: apps
      - group: authentication.k8s.io
      - group: authorization.k8s.io
      - group: autoscaling
      - group: batch
      - group: certificates.k8s.io
      - group: extensions
      - group: metrics.k8s.io
      - group: networking.k8s.io
      - group: policy
      - group: rbac.authorization.k8s.io
      - group: scheduling.k8s.io
      - group: settings.k8s.io
      - group: storage.k8s.io
    verbs:
      - get
      - list
      - watch

  # Default level for known APIs
  - level: RequestResponse
    omitStages:
      - RequestReceived
    resources:
      - group: &quot;&quot;
      - group: admissionregistration.k8s.io
      - group: apiextensions.k8s.io
      - group: apiregistration.k8s.io
      - group: apps
      - group: authentication.k8s.io
      - group: authorization.k8s.io
      - group: autoscaling
      - group: batch
      - group: certificates.k8s.io
      - group: extensions
      - group: metrics.k8s.io
      - group: networking.k8s.io
      - group: policy
      - group: rbac.authorization.k8s.io
      - group: scheduling.k8s.io
      - group: settings.k8s.io
      - group: storage.k8s.io

  # Default level for all other requests.
  - level: Metadata
    omitStages:
      - RequestReceived
EOF
[root@k8s-master01 work]# for master_ip in ${
   
     MASTER_IPS[@]}
  do
    echo &quot;&gt;&gt;&gt; ${master_ip}&quot;
    scp audit-policy.yaml root@${
   
     master_ip}:/etc/kubernetes/audit-policy.yaml
  done
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br><span class="line-number">197</span><br><span class="line-number">198</span><br></div></div><h4 id="_4-配置-metrics-server"><a href="#_4-配置-metrics-server" class="header-anchor">#</a> 4）配置 Metrics-Server</h4> <p>创建<code>metrics-server</code> 的 CA 证书请求文件</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>[root@k8s-master01 work]# cat &gt; proxy-client-csr.json &lt;&lt; EOF
{
   
     
  &quot;CN&quot;: &quot;system:metrics-server&quot;,
  &quot;hosts&quot;: [],
  &quot;key&quot;: {
   
     
    &quot;algo&quot;: &quot;rsa&quot;,
    &quot;size&quot;: 2048
  },
  &quot;names&quot;: [
    {
   
     
      &quot;C&quot;: &quot;CN&quot;,
      &quot;ST&quot;: &quot;Shanghai&quot;,
      &quot;L&quot;: &quot;Shanghai&quot;,
      &quot;O&quot;: &quot;k8s&quot;,
      &quot;OU&quot;: &quot;System&quot;
    }
  ]
}
EOF
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>生成证书和密钥</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>[root@k8s-master01 work]# cfssl gencert -ca=/opt/k8s/work/ca.pem -ca-key=/opt/k8s/work/ca-key.pem -config=/opt/k8s/work/ca-config.json -profile=kubernetes proxy-client-csr.json | cfssljson -bare proxy-client
[root@k8s-master01 work]# for master_ip in ${
   
     MASTER_IPS[@]}
  do
    echo &quot;&gt;&gt;&gt; ${master_ip}&quot;
    scp proxy-client*.pem root@${
   
     master_ip}:/etc/kubernetes/cert/
  done
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h4 id="_5-创建启动脚本"><a href="#_5-创建启动脚本" class="header-anchor">#</a> 5）创建启动脚本</h4> <div class="language- line-numbers-mode"><pre class="language-text"><code>[root@k8s-master01 work]# cat &gt; kube-apiserver.service.template &lt;&lt; EOF
[Unit]
Description=Kubernetes API Server
Documentation=https://github.com/GoogleCloudPlatform/kubernetes
After=network.target

[Service]
WorkingDirectory=${
   
     K8S_DIR}/kube-apiserver
ExecStart=/opt/k8s/bin/kube-apiserver \\
  --insecure-port=0 \\
  --secure-port=6443 \\
  --bind-address=##MASTER_IP## \\
  --advertise-address=##MASTER_IP## \\
  --default-not-ready-toleration-seconds=360 \\
  --default-unreachable-toleration-seconds=360 \\
  --feature-gates=DynamicAuditing=true \\
  --max-mutating-requests-inflight=2000 \\
  --max-requests-inflight=4000 \\
  --default-watch-cache-size=200 \\
  --delete-collection-workers=2 \\
  --encryption-provider-config=/etc/kubernetes/encryption-config.yaml \\
  --etcd-cafile=/etc/kubernetes/cert/ca.pem \\
  --etcd-certfile=/etc/kubernetes/cert/kubernetes.pem \\
  --etcd-keyfile=/etc/kubernetes/cert/kubernetes-key.pem \\
  --etcd-servers=${
   
     ETCD_ENDPOINTS} \\
  --tls-cert-file=/etc/kubernetes/cert/kubernetes.pem \\
  --tls-private-key-file=/etc/kubernetes/cert/kubernetes-key.pem \\
  --audit-dynamic-configuration \\
  --audit-log-maxage=30 \\
  --audit-log-maxbackup=3 \\
  --audit-log-maxsize=100 \\
  --audit-log-truncate-enabled=true \\
  --audit-log-path=${
   
     K8S_DIR}/kube-apiserver/audit.log \\
  --audit-policy-file=/etc/kubernetes/audit-policy.yaml \\
  --profiling \\
  --anonymous-auth=false \\
  --client-ca-file=/etc/kubernetes/cert/ca.pem \\
  --enable-bootstrap-token-auth=true \\
  --requestheader-allowed-names=&quot;system:metrics-server&quot; \\
  --requestheader-client-ca-file=/etc/kubernetes/cert/ca.pem \\
  --requestheader-extra-headers-prefix=X-Remote-Extra- \\
  --requestheader-group-headers=X-Remote-Group \\
  --requestheader-username-headers=X-Remote-User \\
  --service-account-key-file=/etc/kubernetes/cert/ca.pem \\
  --authorization-mode=Node,RBAC \\
  --runtime-config=api/all=true \\
  --enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,MutatingAdmissionWebhook,ValidatingAdmissionWebhook,ResourceQuota,NodeRestriction \\
  --allow-privileged=true \\
  --apiserver-count=3 \\
  --event-ttl=168h \\
  --kubelet-certificate-authority=/etc/kubernetes/cert/ca.pem \\
  --kubelet-client-certificate=/etc/kubernetes/cert/kubernetes.pem \\
  --kubelet-client-key=/etc/kubernetes/cert/kubernetes-key.pem \\
  --kubelet-https=true \\
  --kubelet-timeout=10s \\
  --proxy-client-cert-file=/etc/kubernetes/cert/proxy-client.pem \\
  --proxy-client-key-file=/etc/kubernetes/cert/proxy-client-key.pem \\
  --service-cluster-ip-range=${
   
     SERVICE_CIDR} \\
  --service-node-port-range=${
   
     NODE_PORT_RANGE} \\
  --logtostderr=true \\
  --v=2
Restart=on-failure
RestartSec=10
Type=notify
LimitNOFILE=65535

[Install]
WantedBy=multi-user.target
EOF
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br></div></div><h4 id="_6-启动-kube-apiserver-并验证"><a href="#_6-启动-kube-apiserver-并验证" class="header-anchor">#</a> 6）启动 Kube-APIServer 并验证</h4> <div class="language- line-numbers-mode"><pre class="language-text"><code>[root@k8s-master01 work]# for (( A=0; A &lt; 2; A++ ))
  do
    sed -e &quot;s/##MASTER_NAME##/${MASTER_NAMES[A]}/&quot; -e &quot;s/##MASTER_IP##/${MASTER_IPS[A]}/&quot; kube-apiserver.service.template &gt; kube-apiserver-${
   
     MASTER_IPS[A]}.service
  done
[root@k8s-master01 work]# for master_ip in ${
   
     MASTER_IPS[@]}
  do
    echo &quot;&gt;&gt;&gt; ${master_ip}&quot;
    scp kube-apiserver-${
   
     master_ip}.service root@${
   
     master_ip}:/etc/systemd/system/kube-apiserver.service
    ssh root@${
   
     master_ip} &quot;mkdir -p ${K8S_DIR}/kube-apiserver&quot;
    ssh root@${
   
     master_ip} &quot;systemctl daemon-reload &amp;&amp; systemctl enable kube-apiserver --now&quot;
  done
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>查看Kube-APIServer 写入 ETCD 的数据</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>[root@k8s-master01 work]# ETCDCTL_API=3 etcdctl \
--endpoints=${
   
     ETCD_ENDPOINTS} \
--cacert=/opt/k8s/work/ca.pem \
--cert=/opt/k8s/work/etcd.pem \
--key=/opt/k8s/work/etcd-key.pem \
get /registry/ --prefix --keys-only
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>查看集群信息</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>[root@k8s-master01 work]# kubectl cluster-info
[root@k8s-master01 work]# kubectl get all --all-namespaces
[root@k8s-master01 work]# kubectl get componentstatuses
[root@k8s-master01 work]# netstat -anpt | grep 6443
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h3x2em3642j20u009qad2.jpg" alt="图片">
授予<code>kube-apiserver</code> 访问 <code>kubelet</code> API 的权限</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>[root@k8s-master01 work]# kubectl create clusterrolebinding kube-apiserver:kubelet-apis --clusterrole=system:kubelet-api-admin --user kubernetes
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="_2-安装-controller-manager-组件"><a href="#_2-安装-controller-manager-组件" class="header-anchor">#</a> 2.安装 Controller Manager 组件</h3> <h4 id="_1-创建-controller-manager-证书和密钥"><a href="#_1-创建-controller-manager-证书和密钥" class="header-anchor">#</a> 1）创建 Controller Manager 证书和密钥</h4> <div class="language- line-numbers-mode"><pre class="language-text"><code>[root@k8s-master01 work]# cat &gt; kube-controller-manager-csr.json &lt;&lt; EOF
{
   
     
  &quot;CN&quot;: &quot;system:kube-controller-manager&quot;,
  &quot;hosts&quot;: [
    &quot;127.0.0.1&quot;,
    &quot;192.168.1.1&quot;,
    &quot;192.168.1.2&quot;
  ],
  &quot;key&quot;: {
   
     
    &quot;algo&quot;: &quot;rsa&quot;,
    &quot;size&quot;: 2048
  },
  &quot;names&quot;: [
    {
   
     
      &quot;C&quot;: &quot;CN&quot;,
      &quot;ST&quot;: &quot;Shanghai&quot;,
      &quot;L&quot;: &quot;Shanghai&quot;,
      &quot;O&quot;: &quot;system:kube-controller-manager&quot;,
      &quot;OU&quot;: &quot;System&quot;
    }
  ]
}
EOF
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><h4 id="_2-生成证书和密钥-4"><a href="#_2-生成证书和密钥-4" class="header-anchor">#</a> 2）生成证书和密钥</h4> <div class="language- line-numbers-mode"><pre class="language-text"><code>[root@k8s-master01 work]# cfssl gencert -ca=/opt/k8s/work/ca.pem -ca-key=/opt/k8s/work/ca-key.pem -config=/opt/k8s/work/ca-config.json -profile=kubernetes kube-controller-manager-csr.json | cfssljson -bare kube-controller-manager
[root@k8s-master01 work]# for master_ip in ${
   
     MASTER_IPS[@]}
  do
    echo &quot;&gt;&gt;&gt; ${master_ip}&quot;
    scp kube-controller-manager*.pem root@${
   
     master_ip}:/etc/kubernetes/cert/
  done
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h4 id="_3-创建-kubeconfig-文件"><a href="#_3-创建-kubeconfig-文件" class="header-anchor">#</a> 3）创建 Kubeconfig 文件</h4> <div class="language- line-numbers-mode"><pre class="language-text"><code>[root@k8s-master01 work]# kubectl config set-cluster kubernetes \
--certificate-authority=/opt/k8s/work/ca.pem \
--embed-certs=true \
--server=${
   
     KUBE_APISERVER} \
--kubeconfig=kube-controller-manager.kubeconfig
[root@k8s-master01 work]# kubectl config set-credentials system:kube-controller-manager \
--client-certificate=kube-controller-manager.pem \
--client-key=kube-controller-manager-key.pem \
--embed-certs=true \
--kubeconfig=kube-controller-manager.kubeconfig
[root@k8s-master01 work]# kubectl config set-context system:kube-controller-manager \
--cluster=kubernetes \
--user=system:kube-controller-manager \
--kubeconfig=kube-controller-manager.kubeconfig
[root@k8s-master01 work]# kubectl config use-context system:kube-controller-manager --kubeconfig=kube-controller-manager.kubeconfig
[root@k8s-master01 work]# for master_ip in ${
   
     MASTER_IPS[@]}
  do
    echo &quot;&gt;&gt;&gt; ${master_ip}&quot;
    scp kube-controller-manager.kubeconfig root@${
   
     master_ip}:/etc/kubernetes/
  done
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><h4 id="_4-创建启动脚本"><a href="#_4-创建启动脚本" class="header-anchor">#</a> 4）创建启动脚本</h4> <div class="language- line-numbers-mode"><pre class="language-text"><code>[root@k8s-master01 work]# cat &gt; kube-controller-manager.service.template &lt;&lt; EOF
[Unit]
Description=Kubernetes Controller Manager
Documentation=https://github.com/GoogleCloudPlatform/kubernetes

[Service]
WorkingDirectory=${
   
     K8S_DIR}/kube-controller-manager
ExecStart=/opt/k8s/bin/kube-controller-manager \\
  --secure-port=10257 \\
  --bind-address=127.0.0.1 \\
  --profiling \\
  --cluster-name=kubernetes \\
  --controllers=*,bootstrapsigner,tokencleaner \\
  --kube-api-qps=1000 \\
  --kube-api-burst=2000 \\
  --leader-elect \\
  --use-service-account-credentials\\
  --concurrent-service-syncs=2 \\
  --tls-cert-file=/etc/kubernetes/cert/kube-controller-manager.pem \\
  --tls-private-key-file=/etc/kubernetes/cert/kube-controller-manager-key.pem \\
  --authentication-kubeconfig=/etc/kubernetes/kube-controller-manager.kubeconfig \\
  --client-ca-file=/etc/kubernetes/cert/ca.pem \\
  --requestheader-allowed-names=&quot;system:metrics-server&quot; \\
  --requestheader-client-ca-file=/etc/kubernetes/cert/ca.pem \\
  --requestheader-extra-headers-prefix=&quot;X-Remote-Extra-&quot; \\
  --requestheader-group-headers=X-Remote-Group \\
  --requestheader-username-headers=X-Remote-User \\
  --cluster-signing-cert-file=/etc/kubernetes/cert/ca.pem \\
  --cluster-signing-key-file=/etc/kubernetes/cert/ca-key.pem \\
  --experimental-cluster-signing-duration=87600h \\
  --horizontal-pod-autoscaler-sync-period=10s \\
  --concurrent-deployment-syncs=10 \\
  --concurrent-gc-syncs=30 \\
  --node-cidr-mask-size=24 \\
  --service-cluster-ip-range=${
   
     SERVICE_CIDR} \\
  --cluster-cidr=${
   
     CLUSTER_CIDR} \\
  --pod-eviction-timeout=6m \\
  --terminated-pod-gc-threshold=10000 \\
  --root-ca-file=/etc/kubernetes/cert/ca.pem \\
  --service-account-private-key-file=/etc/kubernetes/cert/ca-key.pem \\
  --kubeconfig=/etc/kubernetes/kube-controller-manager.kubeconfig \\
  --logtostderr=true \\
  --v=2
Restart=on-failure
RestartSec=5

[Install]
WantedBy=multi-user.target
EOF
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br></div></div><h4 id="_4-启动并验证-2"><a href="#_4-启动并验证-2" class="header-anchor">#</a> 4）启动并验证</h4> <div class="language- line-numbers-mode"><pre class="language-text"><code>[root@k8s-master01 work]# for master_ip in ${
   
     MASTER_IPS[@]}
  do
    echo &quot;&gt;&gt;&gt; ${master_ip}&quot;
    scp kube-controller-manager.service.template root@${
   
     master_ip}:/etc/systemd/system/kube-controller-manager.service
    ssh root@${
   
     master_ip} &quot;mkdir -p ${K8S_DIR}/kube-controller-manager&quot;
    ssh root@${
   
     master_ip} &quot;systemctl daemon-reload &amp;&amp; systemctl enable kube-controller-manager --now&quot;
  done
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>查看输出的 Metrics</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>[root@k8s-master01 work]# curl -s --cacert /opt/k8s/work/ca.pem --cert /opt/k8s/work/admin.pem --key /opt/k8s/work/admin-key.pem https://127.0.0.1:10257/metrics | head
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>查看权限</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>[root@k8s-master01 work]# kubectl describe clusterrole system:kube-controller-manager
[root@k8s-master01 work]# kubectl get clusterrole | grep controller
[root@k8s-master01 work]# kubectl describe clusterrole system:controller:deployment-controller
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>查看当前的 Leader</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>[root@k8s-master01 work]# kubectl get endpoints kube-controller-manager --namespace=kube-system -o yaml
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="_3-安装-kube-scheduler-组件"><a href="#_3-安装-kube-scheduler-组件" class="header-anchor">#</a> 3.安装 Kube-Scheduler 组件</h3> <h4 id="_1-创建-kube-scheduler-证书和密钥"><a href="#_1-创建-kube-scheduler-证书和密钥" class="header-anchor">#</a> 1）创建 Kube-Scheduler 证书和密钥</h4> <div class="language- line-numbers-mode"><pre class="language-text"><code>[root@k8s-master01 work]# cat &gt; kube-scheduler-csr.json &lt;&lt; EOF
{
   
     
  &quot;CN&quot;: &quot;system:kube-scheduler&quot;,
  &quot;hosts&quot;: [
    &quot;127.0.0.1&quot;,
    &quot;192.168.1.1&quot;,
    &quot;192.168.1.2&quot;
  ],
  &quot;key&quot;: {
   
     
    &quot;algo&quot;: &quot;rsa&quot;,
    &quot;size&quot;: 2048
  },
  &quot;names&quot;: [
    {
   
     
      &quot;C&quot;: &quot;CN&quot;,
      &quot;ST&quot;: &quot;Shanghai&quot;,
      &quot;L&quot;: &quot;Shanghai&quot;,
      &quot;O&quot;: &quot;system:kube-scheduler&quot;,
      &quot;OU&quot;: &quot;System&quot;
    }
  ]
}
EOF
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><h4 id="_2-生成证书和密钥-5"><a href="#_2-生成证书和密钥-5" class="header-anchor">#</a> 2）生成证书和密钥</h4> <div class="language- line-numbers-mode"><pre class="language-text"><code>[root@k8s-master01 work]# cfssl gencert -ca=/opt/k8s/work/ca.pem -ca-key=/opt/k8s/work/ca-key.pem -config=/opt/k8s/work/ca-config.json -profile=kubernetes kube-scheduler-csr.json | cfssljson -bare kube-scheduler
[root@k8s-master01 work]# for master_ip in ${
   
     MASTER_IPS[@]}
  do
    echo &quot;&gt;&gt;&gt; ${master_ip}&quot;
    scp kube-scheduler*.pem root@${
   
     master_ip}:/etc/kubernetes/cert/
  done
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h4 id="_3-创建-kubeconfig-文件-2"><a href="#_3-创建-kubeconfig-文件-2" class="header-anchor">#</a> 3）创建 Kubeconfig 文件</h4> <div class="language- line-numbers-mode"><pre class="language-text"><code>[root@k8s-master01 work]# kubectl config set-cluster kubernetes \
--certificate-authority=/opt/k8s/work/ca.pem \
--embed-certs=true \
--server=${
   
     KUBE_APISERVER} \
--kubeconfig=kube-scheduler.kubeconfig
[root@k8s-master01 work]# kubectl config set-credentials system:kube-scheduler \
--client-certificate=kube-scheduler.pem \
--client-key=kube-scheduler-key.pem \
--embed-certs=true \
--kubeconfig=kube-scheduler.kubeconfig
[root@k8s-master01 work]# kubectl config set-context system:kube-scheduler \
--cluster=kubernetes \
--user=system:kube-scheduler \
--kubeconfig=kube-scheduler.kubeconfig
[root@k8s-master01 work]# kubectl config use-context system:kube-scheduler --kubeconfig=kube-scheduler.kubeconfig
[root@k8s-master01 work]# for master_ip in ${
   
     MASTER_IPS[@]}
  do
    echo &quot;&gt;&gt;&gt; ${master_ip}&quot;
    scp kube-scheduler.kubeconfig root@${
   
     master_ip}:/etc/kubernetes/
  done
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><h4 id="_4-创建-kube-scheduler-配置文件"><a href="#_4-创建-kube-scheduler-配置文件" class="header-anchor">#</a> 4）创建 Kube-Scheduler 配置文件</h4> <div class="language- line-numbers-mode"><pre class="language-text"><code>[root@k8s-master01 work]# cat &gt; kube-scheduler.yaml.template &lt;&lt; EOF
apiVersion: kubescheduler.config.k8s.io/v1alpha1
kind: KubeSchedulerConfiguration
bindTimeoutSeconds: 600
clientConnection:
  burst: 200
  kubeconfig: &quot;/etc/kubernetes/kube-scheduler.kubeconfig&quot;
  qps: 100
enableContentionProfiling: false
enableProfiling: true
hardPodAffinitySymmetricWeight: 1
healthzBindAddress: 127.0.0.1:10251
leaderElection:
  leaderElect: true
metricsBindAddress: 127.0.0.1:10251
EOF
[root@k8s-master01 work]# for master_ip in ${
   
     MASTER_IPS[@]}
  do
    echo &quot;&gt;&gt;&gt; ${master_ip}&quot;
    scp kube-scheduler.yaml.template root@${
   
     master_ip}:/etc/kubernetes/kube-scheduler.yaml
  done
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><h4 id="_5-创建启动脚本-2"><a href="#_5-创建启动脚本-2" class="header-anchor">#</a> 5）创建启动脚本</h4> <div class="language- line-numbers-mode"><pre class="language-text"><code>[root@k8s-master01 work]# cat &gt; kube-scheduler.service.template &lt;&lt; EOF
[Unit]
Description=Kubernetes Scheduler
Documentation=https://github.com/GoogleCloudPlatform/kubernetes

[Service]
WorkingDirectory=${
   
     K8S_DIR}/kube-scheduler
ExecStart=/opt/k8s/bin/kube-scheduler \\
  --port=0 \\
  --secure-port=10259 \\
  --bind-address=127.0.0.1 \\
  --config=/etc/kubernetes/kube-scheduler.yaml \\
  --tls-cert-file=/etc/kubernetes/cert/kube-scheduler.pem \\
  --tls-private-key-file=/etc/kubernetes/cert/kube-scheduler-key.pem \\
  --authentication-kubeconfig=/etc/kubernetes/kube-scheduler.kubeconfig \\
  --client-ca-file=/etc/kubernetes/cert/ca.pem \\
  --requestheader-allowed-names=&quot;system:metrics-server&quot; \\
  --requestheader-client-ca-file=/etc/kubernetes/cert/ca.pem \\
  --requestheader-extra-headers-prefix=&quot;X-Remote-Extra-&quot; \\
  --requestheader-group-headers=X-Remote-Group \\
  --requestheader-username-headers=X-Remote-User \\
  --authorization-kubeconfig=/etc/kubernetes/kube-scheduler.kubeconfig \\
  --logtostderr=true \\
  --v=2
Restart=always
RestartSec=5
StartLimitInterval=0

[Install]
WantedBy=multi-user.target
EOF
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><h4 id="_6-启动并验证"><a href="#_6-启动并验证" class="header-anchor">#</a> 6）启动并验证</h4> <div class="language- line-numbers-mode"><pre class="language-text"><code>[root@k8s-master01 work]# for master_ip in ${
   
     MASTER_IPS[@]}
  do
    echo &quot;&gt;&gt;&gt; ${master_ip}&quot;
    scp kube-scheduler.service.template root@${
   
     master_ip}:/etc/systemd/system/kube-scheduler.service
    ssh root@${
   
     master_ip} &quot;mkdir -p ${K8S_DIR}/kube-scheduler&quot;
    ssh root@${
   
     master_ip} &quot;systemctl daemon-reload &amp;&amp; systemctl enable kube-scheduler --now&quot;
  done
[root@k8s-master01 work]# netstat -nlpt | grep kube-schedule
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><ul><li>10251：接收 http 请求，非安全端口，不需要认证授权；</li> <li>10259：接收 https 请求，安全端口，需要认认证授权（两个接口都对外提供 /metrics 和 /healthz 的访问）</li></ul> <p>查看输出的 Metrics</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>[root@k8s-master01 work]# curl -s --cacert /opt/k8s/work/ca.pem --cert /opt/k8s/work/admin.pem --key /opt/k8s/work/admin-key.pem https://127.0.0.1:10257/metrics | head
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>查看权限</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>[root@k8s-master01 work]# kubectl describe clusterrole system:kube-controller-manager
[root@k8s-master01 work]# kubectl get clusterrole | grep controller
[root@k8s-master01 work]# kubectl describe clusterrole system:controller:deployment-controller
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>查看当前的 Leader</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>[root@k8s-master01 work]# kubectl get endpoints kube-controller-manager --namespace=kube-system -o yaml
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="_4-安装-kubelet-组件"><a href="#_4-安装-kubelet-组件" class="header-anchor">#</a> 4.安装 Kubelet 组件</h3> <div class="language- line-numbers-mode"><pre class="language-text"><code>[root@k8s-master01 work]# for all_ip in ${
   
     ALL_IPS[@]}
  do
    echo &quot;&gt;&gt;&gt; ${all_ip}&quot;
    scp kubernetes/server/bin/kubelet root@${
   
     all_ip}:/opt/k8s/bin/
    ssh root@${
   
     all_ip} &quot;chmod +x /opt/k8s/bin/*&quot;
  done
[root@k8s-master01 work]# for all_name in ${
   
     ALL_NAMES[@]}
  do
    echo &quot;&gt;&gt;&gt; ${all_name}&quot;
    export BOOTSTRAP_TOKEN=$(kubeadm token create \
      --description kubelet-bootstrap-token \
      --groups system:bootstrappers:${
   
     all_name} \
      --kubeconfig ~/.kube/config)
    kubectl config set-cluster kubernetes \
      --certificate-authority=/etc/kubernetes/cert/ca.pem \
      --embed-certs=true \
      --server=${
   
     KUBE_APISERVER} \
      --kubeconfig=kubelet-bootstrap-${
   
     all_name}.kubeconfig
    kubectl config set-credentials kubelet-bootstrap \
      --token=${
   
     BOOTSTRAP_TOKEN} \
      --kubeconfig=kubelet-bootstrap-${
   
     all_name}.kubeconfig
    kubectl config set-context default \
      --cluster=kubernetes \
      --user=kubelet-bootstrap \
      --kubeconfig=kubelet-bootstrap-${
   
     all_name}.kubeconfig
    kubectl config use-context default --kubeconfig=kubelet-bootstrap-${
   
     all_name}.kubeconfig
  done
[root@k8s-master01 work]# kubeadm token list --kubeconfig ~/.kube/config     # 查看 Kubeadm 为各节点创建的 Token
[root@k8s-master01 work]# kubectl get secrets -n kube-system | grep bootstrap-token   # 查看各 Token 关联的 Secret
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br></div></div><p><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h3x2emicxoj20u00frgod.jpg" alt="图片"></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>[root@k8s-master01 work]# for all_name in ${
   
     ALL_NAMES[@]}
  do
    echo &quot;&gt;&gt;&gt; ${all_name}&quot;
    scp kubelet-bootstrap-${
   
     all_name}.kubeconfig root@${
   
     all_name}:/etc/kubernetes/kubelet-bootstrap.kubeconfig
  done
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>创建Kubelet 参数配置文件</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>[root@k8s-master01 work]# cat &gt; kubelet-config.yaml.template &lt;&lt; EOF
kind: KubeletConfiguration
apiVersion: kubelet.config.k8s.io/v1beta1
address: &quot;##ALL_IP##&quot;
staticPodPath: &quot;&quot;
syncFrequency: 1m
fileCheckFrequency: 20s
httpCheckFrequency: 20s
staticPodURL: &quot;&quot;
port: 10250
readOnlyPort: 0
rotateCertificates: true
serverTLSBootstrap: true
authentication:
  anonymous:
    enabled: false
  webhook:
    enabled: true
  x509:
    clientCAFile: &quot;/etc/kubernetes/cert/ca.pem&quot;
authorization:
  mode: Webhook
registryPullQPS: 0
registryBurst: 20
eventRecordQPS: 0
eventBurst: 20
enableDebuggingHandlers: true
enableContentionProfiling: true
healthzPort: 10248
healthzBindAddress: &quot;##ALL_IP##&quot;
clusterDomain: &quot;${CLUSTER_DNS_DOMAIN}&quot;
clusterDNS:
  - &quot;${CLUSTER_DNS_SVC_IP}&quot;
nodeStatusUpdateFrequency: 10s
nodeStatusReportFrequency: 1m
imageMinimumGCAge: 2m
imageGCHighThresholdPercent: 85
imageGCLowThresholdPercent: 80
volumeStatsAggPeriod: 1m
kubeletCgroups: &quot;&quot;
systemCgroups: &quot;&quot;
cgroupRoot: &quot;&quot;
cgroupsPerQOS: true
cgroupDriver: cgroupfs
runtimeRequestTimeout: 10m
hairpinMode: promiscuous-bridge
maxPods: 220
podCIDR: &quot;${CLUSTER_CIDR}&quot;
podPidsLimit: -1
resolvConf: /etc/resolv.conf
maxOpenFiles: 1000000
kubeAPIQPS: 1000
kubeAPIBurst: 2000
serializeImagePulls: false
evictionHard:
  memory.available:  &quot;100Mi&quot;
nodefs.available:  &quot;10%&quot;
nodefs.inodesFree: &quot;5%&quot;
imagefs.available: &quot;15%&quot;
evictionSoft: {
   
     }
enableControllerAttachDetach: true
failSwapOn: true
containerLogMaxSize: 20Mi
containerLogMaxFiles: 10
systemReserved: {
   
     }
kubeReserved: {
   
     }
systemReservedCgroup: &quot;&quot;
kubeReservedCgroup: &quot;&quot;
enforceNodeAllocatable: [&quot;pods&quot;]
EOF
[root@k8s-master01 work]# for all_ip in ${
   
     ALL_IPS[@]}
  do
    echo &quot;&gt;&gt;&gt; ${all_ip}&quot;
    sed -e &quot;s/##ALL_IP##/${all_ip}/&quot; kubelet-config.yaml.template &gt; kubelet-config-${
   
     all_ip}.yaml.template
    scp kubelet-config-${
   
     all_ip}.yaml.template root@${
   
     all_ip}:/etc/kubernetes/kubelet-config.yaml
  done
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br></div></div><h4 id="_1-创建-kubelet-启动脚本"><a href="#_1-创建-kubelet-启动脚本" class="header-anchor">#</a> 1）创建 Kubelet 启动脚本</h4> <div class="language- line-numbers-mode"><pre class="language-text"><code>[root@k8s-master01 work]# cat &gt; kubelet.service.template &lt;&lt; EOF
[Unit]
Description=Kubernetes Kubelet
Documentation=https://github.com/GoogleCloudPlatform/kubernetes
After=docker.service
Requires=docker.service

[Service]
WorkingDirectory=${
   
     K8S_DIR}/kubelet
ExecStart=/opt/k8s/bin/kubelet \\
  --bootstrap-kubeconfig=/etc/kubernetes/kubelet-bootstrap.kubeconfig \\
  --cert-dir=/etc/kubernetes/cert \\
  --cgroup-driver=cgroupfs \\
  --cni-conf-dir=/etc/cni/net.d \\
  --container-runtime=docker \\
  --container-runtime-endpoint=unix:///var/run/dockershim.sock \\
  --root-dir=${
   
     K8S_DIR}/kubelet \\
  --kubeconfig=/etc/kubernetes/kubelet.kubeconfig \\
  --config=/etc/kubernetes/kubelet-config.yaml \\
  --hostname-override=##ALL_NAME## \\
  --pod-infra-container-image=registry.aliyuncs.com/google_containers/pause-amd64:3.2 \\
  --image-pull-progress-deadline=15m \\
  --volume-plugin-dir=${
   
     K8S_DIR}/kubelet/kubelet-plugins/volume/exec/ \\
  --logtostderr=true \\
  --v=2
Restart=always
RestartSec=5
StartLimitInterval=0

[Install]
WantedBy=multi-user.target
EOF
[root@k8s-master01 work]# for all_name in ${
   
     ALL_NAMES[@]}
  do
    echo &quot;&gt;&gt;&gt; ${all_name}&quot;
    sed -e &quot;s/##ALL_NAME##/${all_name}/&quot; kubelet.service.template &gt; kubelet-${
   
     all_name}.service
    scp kubelet-${
   
     all_name}.service root@${
   
     all_name}:/etc/systemd/system/kubelet.service
  done
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br></div></div><h4 id="_2-启动并验证"><a href="#_2-启动并验证" class="header-anchor">#</a> 2）启动并验证</h4> <p>授权</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>[root@k8s-master01 ~]# kubectl create clusterrolebinding kubelet-bootstrap --clusterrole=system:node-bootstrapper --group=system:bootstrappers
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>启动Kubelet</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>[root@k8s-master01 work]# for all_name in ${
   
     ALL_NAMES[@]}
  do
    echo &quot;&gt;&gt;&gt; ${all_name}&quot;
    ssh root@${
   
     all_name} &quot;mkdir -p ${K8S_DIR}/kubelet/kubelet-plugins/volume/exec/&quot;
    ssh root@${
   
     all_name} &quot;systemctl daemon-reload &amp;&amp; systemctl enable kubelet --now&quot;
  done
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>查看Kubelet 服务</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>[root@k8s-master01 work]# for all_name in ${
   
     ALL_NAMES[@]}
  do
    echo &quot;&gt;&gt;&gt; ${all_name}&quot;
    ssh root@${
   
     all_name} &quot;systemctl status kubelet | grep active&quot;
  done
[root@k8s-master01 work]# kubectl get csr         # 因为我们还没做认证. 所以显示 Pengding 状态
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h3x2epunrgj20u00bawhn.jpg" alt="图片"></p> <h4 id="_3-approve-csr-请求"><a href="#_3-approve-csr-请求" class="header-anchor">#</a> 3）Approve CSR 请求</h4> <p>自动Approve CSR 请求（创建三个 ClusterRoleBinding，分别用于自动 <code>approve client</code> <code>renew client</code> <code>renew server</code> 证书）</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>[root@k8s-master01 work]# cat &gt; csr-crb.yaml &lt;&lt; EOF
 # Approve all CSRs for the group &quot;system:bootstrappers&quot;
 kind: ClusterRoleBinding
 apiVersion: rbac.authorization.k8s.io/v1
 metadata:
   name: auto-approve-csrs-for-group
 subjects:
 - kind: Group
   name: system:bootstrappers
   apiGroup: rbac.authorization.k8s.io
 roleRef:
   kind: ClusterRole
   name: system:certificates.k8s.io:certificatesigningrequests:nodeclient
   apiGroup: rbac.authorization.k8s.io
---
 # To let a node of the group &quot;system:nodes&quot; renew its own credentials
 kind: ClusterRoleBinding
 apiVersion: rbac.authorization.k8s.io/v1
 metadata:
   name: node-client-cert-renewal
 subjects:
 - kind: Group
   name: system:nodes
   apiGroup: rbac.authorization.k8s.io
 roleRef:
   kind: ClusterRole
   name: system:certificates.k8s.io:certificatesigningrequests:selfnodeclient
   apiGroup: rbac.authorization.k8s.io
---
# A ClusterRole which instructs the CSR approver to approve a node requesting a
# serving cert matching its client cert.
kind: ClusterRole
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: approve-node-server-renewal-csr
rules:
- apiGroups: [&quot;certificates.k8s.io&quot;]
  resources: [&quot;certificatesigningrequests/selfnodeserver&quot;]
  verbs: [&quot;create&quot;]
---
 # To let a node of the group &quot;system:nodes&quot; renew its own server credentials
 kind: ClusterRoleBinding
 apiVersion: rbac.authorization.k8s.io/v1
 metadata:
   name: node-server-cert-renewal
 subjects:
 - kind: Group
   name: system:nodes
   apiGroup: rbac.authorization.k8s.io
 roleRef:
   kind: ClusterRole
   name: approve-node-server-renewal-csr
   apiGroup: rbac.authorization.k8s.io
EOF
[root@k8s-master01 work]# kubectl apply -f csr-crb.yaml
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br></div></div><p>验证（等待一段时间 <code>1 ~ 5</code> 分钟)，三个节点的 CSR 都自动 <code>approved</code>）</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>[root@k8s-master01 work]# kubectl get csr | grep boot    # 等待一段时间 (1-10 分钟)，三个节点的 CSR 都自动 approved
[root@k8s-master01 work]# kubectl get nodes       # 所有节点均 Ready
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h3x2es6qvhj20u0088wgr.jpg" alt="图片"></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>[root@k8s-master01 ~]# ls -l /etc/kubernetes/kubelet.kubeconfig
[root@k8s-master01 ~]# ls -l /etc/kubernetes/cert/ | grep kubelet
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h3x2enujkhj20u0071abm.jpg" alt="图片"></p> <h4 id="_4-手动-approve-server-cert-csr"><a href="#_4-手动-approve-server-cert-csr" class="header-anchor">#</a> 4）手动 Approve Server Cert Csr</h4> <p>基于安全性考虑，CSR <code>approving controllers</code> 不会自动 <code>approve kubelet server</code> 证书签名请求，需要手动 <code>approve</code></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>[root@k8s-master01 ~]# kubectl get csr | grep node
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h3x2en981oj20u00frgod.jpg" alt="图片"></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>[root@k8s-master01 ~]# kubectl get csr | grep Pending | awk '{print $1}' | xargs kubectl certificate approve
[root@k8s-master01 ~]# ls -l /etc/kubernetes/cert/kubelet-*
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h3x2er685wj20u007idib.jpg" alt="图片"></p> <h4 id="_5-kubelet-api-接口配置"><a href="#_5-kubelet-api-接口配置" class="header-anchor">#</a> 5）Kubelet API 接口配置</h4> <p>Kubelet API 认证和授权</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>[root@k8s-master01 ~]# curl -s --cacert /etc/kubernetes/cert/ca.pem https://192.168.1.1:10250/metrics
[root@k8s-master01 ~]# curl -s --cacert /etc/kubernetes/cert/ca.pem -H &quot;Authorization: Bearer 123456&quot; https://192.168.1.1:10250/metrics
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><img src="https://mmbiz.qpic.cn/mmbiz_png/GpcH5Yqqj0n9Cliag8kbwng634qNfmqFj5yanN3ZIMwTF9H9lp2oicQ5RsXgW1cU6UcFcdzfmxjzNial2tmj7tibbw/640?wx_fmt=png&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="图片">
证书认证和授权</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>// 默认权限不足
[root@k8s-master01 ~]# curl -s --cacert /etc/kubernetes/cert/ca.pem --cert /etc/kubernetes/cert/kube-controller-manager.pem --key /etc/kubernetes/cert/kube-controller-manager-key.pem https://192.168.1.1:10250/metrics
// 使用最高权限的 admin
[root@k8s-master01 ~]# curl -s --cacert /etc/kubernetes/cert/ca.pem --cert /opt/k8s/work/admin.pem --key /opt/k8s/work/admin-key.pem https://192.168.1.1:10250/metrics | head
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>创建Bear Token 认证和授权</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>[root@k8s-master01 ~]# kubectl create serviceaccount kubelet-api-test
[root@k8s-master01 ~]# kubectl create clusterrolebinding kubelet-api-test --clusterrole=system:kubelet-api-admin --serviceaccount=default:kubelet-api-test
[root@k8s-master01 ~]# SECRET=$(kubectl get secrets | grep kubelet-api-test | awk '{print $1}')
[root@k8s-master01 ~]# TOKEN=$(kubectl describe secret ${
   
     SECRET} | grep -E '^token' | awk '{print $2}')
[root@k8s-master01 ~]# echo ${
   
     TOKEN}
[root@k8s-master01 ~]# curl -s --cacert /etc/kubernetes/cert/ca.pem -H &quot;Authorization: Bearer ${TOKEN}&quot; https://192.168.1.1:10250/metrics | head
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h3 id="_5-安装-kube-proxy-组件"><a href="#_5-安装-kube-proxy-组件" class="header-anchor">#</a> 5.安装 Kube-Proxy 组件</h3> <p>Kube-Proxy 运行在所有主机上，用来监听 APIServer 中的 Service 和 Endpoint 的变化情况，并创建路由规则来提供服务 IP 和负载均衡功能。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>[root@k8s-master01 work]# for all_ip in ${
   
     ALL_IPS[@]}
  do
    echo &quot;&gt;&gt;&gt; ${all_ip}&quot;
    scp kubernetes/server/bin/kube-proxy root@${
   
     all_ip}:/opt/k8s/bin/
    ssh root@${
   
     all_ip} &quot;chmod +x /opt/k8s/bin/*&quot;
  done
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h4 id="_1-创建-kube-proxy-证书和密钥"><a href="#_1-创建-kube-proxy-证书和密钥" class="header-anchor">#</a> 1）创建 Kube-Proxy 证书和密钥</h4> <p>创建Kube-Proxy 的 CA 证书请求文件</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>[root@k8s-master01 work]# cat &gt; kube-proxy-csr.json &lt;&lt; EOF
{
   
     
  &quot;CN&quot;: &quot;system:kube-proxy&quot;,
  &quot;key&quot;: {
   
     
    &quot;algo&quot;: &quot;rsa&quot;,
    &quot;size&quot;: 2048
  },
  &quot;names&quot;: [
    {
   
     
      &quot;C&quot;: &quot;CN&quot;,
      &quot;ST&quot;: &quot;Shanghai&quot;,
      &quot;L&quot;: &quot;Shanghai&quot;,
      &quot;O&quot;: &quot;k8s&quot;,
      &quot;OU&quot;: &quot;System&quot;
    }
  ]
}
EOF
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><h4 id="_2-生成证书和密钥-6"><a href="#_2-生成证书和密钥-6" class="header-anchor">#</a> 2）生成证书和密钥</h4> <div class="language- line-numbers-mode"><pre class="language-text"><code>[root@k8s-master01 work]# cfssl gencert -ca=/opt/k8s/work/ca.pem -ca-key=/opt/k8s/work/ca-key.pem -config=/opt/k8s/work/ca-config.json -profile=kubernetes kube-proxy-csr.json | cfssljson -bare kube-proxy
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="_3-创建-kubeconfig-文件-3"><a href="#_3-创建-kubeconfig-文件-3" class="header-anchor">#</a> 3）创建 Kubeconfig 文件</h4> <div class="language- line-numbers-mode"><pre class="language-text"><code>[root@k8s-master01 work]# kubectl config set-cluster kubernetes \
  --certificate-authority=/opt/k8s/work/ca.pem \
  --embed-certs=true \
  --server=${
   
     KUBE_APISERVER} \
  --kubeconfig=kube-proxy.kubeconfig

[root@k8s-master01 work]# kubectl config set-credentials kube-proxy \
  --client-certificate=kube-proxy.pem \
  --client-key=kube-proxy-key.pem \
  --embed-certs=true \
  --kubeconfig=kube-proxy.kubeconfig

[root@k8s-master01 work]# kubectl config set-context default \
  --cluster=kubernetes \
  --user=kube-proxy \
  --kubeconfig=kube-proxy.kubeconfig

[root@k8s-master01 work]# kubectl config use-context default --kubeconfig=kube-proxy.kubeconfig
[root@k8s-master01 work]# for all_ip in ${
   
     ALL_IPS[@]}
  do
    echo &quot;&gt;&gt;&gt; ${all_ip}&quot;
    scp kube-proxy.kubeconfig root@${
   
     all_ip}:/etc/kubernetes/
  done
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><h4 id="_4-创建-kube-proxy-配置文件"><a href="#_4-创建-kube-proxy-配置文件" class="header-anchor">#</a> 4）创建 Kube-Proxy 配置文件</h4> <div class="language- line-numbers-mode"><pre class="language-text"><code>[root@k8s-master01 work]# cat &gt; kube-proxy-config.yaml.template &lt;&lt; EOF
kind: KubeProxyConfiguration
apiVersion: kubeproxy.config.k8s.io/v1alpha1
clientConnection:
  burst: 200
  kubeconfig: &quot;/etc/kubernetes/kube-proxy.kubeconfig&quot;
  qps: 100
bindAddress: ##ALL_IP##
healthzBindAddress: ##ALL_IP##:10256
metricsBindAddress: ##ALL_IP##:10249
enableProfiling: true
clusterCIDR: ${
   
     CLUSTER_CIDR}
hostnameOverride: ##ALL_NAME##
mode: &quot;ipvs&quot;
portRange: &quot;&quot;
kubeProxyIPTablesConfiguration:
  masqueradeAll: false
kubeProxyIPVSConfiguration:
  scheduler: rr
  excludeCIDRs: []
EOF
[root@k8s-master01 work]# for (( i=0; i &lt; 3; i++ ))
  do
    echo &quot;&gt;&gt;&gt; ${ALL_NAMES[i]}&quot;
    sed -e &quot;s/##ALL_NAME##/${ALL_NAMES[i]}/&quot; -e &quot;s/##ALL_IP##/${ALL_IPS[i]}/&quot; kube-proxy-config.yaml.template &gt; kube-proxy-config-${
   
     ALL_NAMES[i]}.yaml.template
    scp kube-proxy-config-${
   
     ALL_NAMES[i]}.yaml.template root@${
   
     ALL_NAMES[i]}:/etc/kubernetes/kube-proxy-config.yaml
  done
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><h4 id="_4-创建启动脚本-2"><a href="#_4-创建启动脚本-2" class="header-anchor">#</a> 4）创建启动脚本</h4> <div class="language- line-numbers-mode"><pre class="language-text"><code>[root@k8s-master01 work]# cat &gt; kube-proxy.service &lt;&lt; EOF
[Unit]
Description=Kubernetes Kube-Proxy Server
Documentation=https://github.com/GoogleCloudPlatform/kubernetes
After=network.target

[Service]
WorkingDirectory=${
   
     K8S_DIR}/kube-proxy
ExecStart=/opt/k8s/bin/kube-proxy \\
  --config=/etc/kubernetes/kube-proxy-config.yaml \\
  --logtostderr=true \\
  --v=2
Restart=on-failure
RestartSec=5
LimitNOFILE=65536

[Install]
WantedBy=multi-user.target
EOF
[root@k8s-master01 work]# for all_name in ${
   
     ALL_NAMES[@]}
  do
    echo &quot;&gt;&gt;&gt; ${all_name}&quot;
    scp kube-proxy.service root@${
   
     all_name}:/etc/systemd/system/
  done
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><h4 id="_5-启动并验证"><a href="#_5-启动并验证" class="header-anchor">#</a> 5）启动并验证</h4> <div class="language- line-numbers-mode"><pre class="language-text"><code>[root@k8s-master01 work]# for all_ip in ${
   
     ALL_IPS[@]}
  do
    echo &quot;&gt;&gt;&gt; ${all_ip}&quot;
    ssh root@${
   
     all_ip} &quot;mkdir -p ${K8S_DIR}/kube-proxy&quot;
    ssh root@${
   
     all_ip} &quot;modprobe ip_vs_rr&quot;
    ssh root@${
   
     all_ip} &quot;systemctl daemon-reload &amp;&amp; systemctl enable kube-proxy --now&quot;
  done
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>查看<code>ipvs</code> 路由规则</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>[root@k8s-master01 work]# ipvsadm -ln
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><img src="https://mmbiz.qpic.cn/mmbiz_png/GpcH5Yqqj0n9Cliag8kbwng634qNfmqFjG7AgZtVk1h0M13PY5PCBToFibso96WL9KzUZcbfnUnRoPw4SXN1xeYw/640?wx_fmt=png&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="图片"> <strong>问题：</strong> 当我们在启动 <code>kube-proxy</code> 组件后，通过 <code>systemctl</code> 查看该组件状态时，出现如下错误</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>Not using --random-fully in the MASQUERADE rule for iptables because the local version of iptables does not support it
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>上面报错是因为我们的 <code>iptables</code> 版本不支持 <code>--random-fully</code> 配置（1.6.2 版本上支持），所以我们需要对 <code>iptables</code> 进行升级操作。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>[root@master01 work]# wget https://www.netfilter.org/projects/iptables/files/iptables-1.6.2.tar.bz2 --no-check-certificate
[root@master01 work]# for all_name in ${
   
     ALL_NAMES[@]}
  do
    echo &quot;&gt;&gt;&gt; ${all_name}&quot;
    scp iptables-1.6.2.tar.bz2 root@${
   
     all_name}:/root/
    ssh root@${
   
     all_name} &quot;yum -y install gcc make libnftnl-devel libmnl-devel autoconf automake libtool bison flex libnetfilter_conntrack-devel libnetfilter_queue-devel libpcap-devel bzip2&quot;
    ssh root@${
   
     all_name} &quot;export LC_ALL=C &amp;&amp; tar -xf iptables-1.6.2.tar.bz2 &amp;&amp; cd iptables-1.6.2 &amp;&amp; ./autogen.sh &amp;&amp; ./configure &amp;&amp; make &amp;&amp; make install&quot;
    ssh root@${
   
     all_name} &quot;systemctl daemon-reload &amp;&amp; systemctl restart kubelet &amp;&amp; systemctl restart kube-proxy&quot;
  done
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h3 id="_6-安装-coredns-插件"><a href="#_6-安装-coredns-插件" class="header-anchor">#</a> 6.安装 CoreDNS 插件</h3> <h4 id="_1-修改-coredns-配置"><a href="#_1-修改-coredns-配置" class="header-anchor">#</a> 1）修改 Coredns 配置</h4> <div class="language- line-numbers-mode"><pre class="language-text"><code>[root@k8s-master01 ~]# cd /opt/k8s/work/kubernetes/cluster/addons/dns/coredns
[root@k8s-master01 coredns]# cp coredns.yaml.base coredns.yaml
[root@k8s-master01 coredns]# sed -i -e &quot;s/__PILLAR__DNS__DOMAIN__/${CLUSTER_DNS_DOMAIN}/&quot; -e &quot;s/__PILLAR__DNS__SERVER__/${CLUSTER_DNS_SVC_IP}/&quot; -e &quot;s/__PILLAR__DNS__MEMORY__LIMIT__/200Mi/&quot; coredns.yaml
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h4 id="_2-创建-coredns-并启动"><a href="#_2-创建-coredns-并启动" class="header-anchor">#</a> 2）创建 Coredns 并启动</h4> <p>配置调度策略</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>[root@k8s-master01 coredns]# kubectl label nodes k8s-master01 node-role.kubernetes.io/master=true
[root@k8s-master01 coredns]# kubectl label nodes k8s-master02 node-role.kubernetes.io/master=true
[root@k8s-master01 coredns]# vim coredns.yaml
......
apiVersion: apps/v1
kind: Deployment
......
spec:
  replicas: 2               # 配置成两个副本
......
      tolerations:
        - key: &quot;node-role.kubernetes.io/master&quot;
          operator: &quot;Equal&quot;
          value: &quot;&quot;
          effect: NoSchedule
      nodeSelector:
        node-role.kubernetes.io/master: &quot;true&quot;
......
[root@k8s-master01 coredns]# kubectl create -f coredns.yaml
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h3x2eq7vvdj20u00b6wgx.jpg" alt="图片"></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>kubectl describe pod Pod-Name -n kube-system           # Pod-Name 你们需要换成自己的
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>因为上面镜像使用的是 K8s 官方的镜像（国外），所以可能会出现：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>Normal   BackOff    72s (x6 over 3m47s)   kubelet, k8s-master01  Back-off pulling image &quot;k8s.gcr.io/coredns:1.6.5&quot;
Warning  Failed     57s (x7 over 3m47s)   kubelet, k8s-master01  Error: ImagePullBackOff
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ul><li>出现如上问题后，我们可以通过拉取其它仓库中的镜像，拉取完后重新打个标签即可。</li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code>如：docker pull k8s.gcr.io/coredns:1.6.5

我们可以：
docker pull registry.aliyuncs.com/google_containers/coredns:1.6.5
docker tag registry.aliyuncs.com/google_containers/coredns:1.6.5 k8s.gcr.io/coredns:1.6.5
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h4 id="_3-验证"><a href="#_3-验证" class="header-anchor">#</a> 3）验证</h4> <div class="language- line-numbers-mode"><pre class="language-text"><code>[root@k8s-master01 coredns]# kubectl run -it --rm test-dns --image=busybox:1.28.4 sh
If you don't see a command prompt, try pressing enter.
/ # 
/ # nslookup kubernetes
Server:    10.20.0.254
Address 1: 10.20.0.254 kube-dns.kube-system.svc.cluster.local

Name:      kubernetes
Address 1: 10.20.0.1 kubernetes.default.svc.cluster.local
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h3 id="_7-安装-dashboard-仪表盘"><a href="#_7-安装-dashboard-仪表盘" class="header-anchor">#</a> 7.安装 Dashboard 仪表盘</h3> <div class="language- line-numbers-mode"><pre class="language-text"><code>[root@k8s-master01 coredns]# cd /opt/k8s/work/
[root@k8s-master01 work]# mkdir metrics
[root@k8s-master01 work]# cd metrics/
[root@k8s-master01 metrics]# wget https://github.com/kubernetes-sigs/metrics-server/releases/download/v0.3.6/components.yaml
[root@k8s-master01 metrics]# vim components.yaml
......
apiVersion: apps/v1
kind: Deployment
metadata:
  name: metrics-server
  namespace: kube-system
  labels:
    k8s-app: metrics-server
spec:
  replicas: 2            # 修改副本数
  selector:
    matchLabels:
      k8s-app: metrics-server
  template:
    metadata:
      name: metrics-server
      labels:
        k8s-app: metrics-server
    spec:
      hostNetwork: true          # 配置主机网络
      serviceAccountName: metrics-server
      volumes:
      # mount in tmp so we can safely use from-scratch images and/or read-only containers
      - name: tmp-dir
        emptyDir: {
   
     }
      containers:
      - name: metrics-server
        image: registry.aliyuncs.com/google_containers/metrics-server-amd64:v0.3.6  # 修改镜像名
        imagePullPolicy: IfNotPresent
        args:
          - --cert-dir=/tmp
          - --secure-port=4443
          - --kubelet-insecure-tls       # 新加的
          - --kubelet-preferred-address-types=InternalIP,Hostname,InternalDNS,ExternalDNS,ExternalIP # 新加的
......
[root@k8s-master01 metrics]# kubectl create -f components.yaml 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br></div></div><p>验证：<img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h3x2erlulxj20u00bqn02.jpg" alt="图片"></p> <h4 id="_1-创建证书"><a href="#_1-创建证书" class="header-anchor">#</a> 1）创建证书</h4> <div class="language- line-numbers-mode"><pre class="language-text"><code>[root@k8s-master01 metrics]# cd /opt/k8s/work/
[root@k8s-master01 work]# mkdir -p /opt/k8s/work/dashboard/certs
[root@k8s-master01 work]# openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout tls.key -out tls.crt -subj &quot;/C=CN/ST=ZheJiang/L=HangZhou/O=Xianghy/OU=Xianghy/CN=k8s.odocker.com&quot;
[root@k8s-master01 work]# for master_ip in ${
   
     MASTER_IPS[@]}
  do
    echo &quot;&gt;&gt;&gt; ${master_ip}&quot;
    ssh root@${
   
     master_ip} &quot;mkdir -p /opt/k8s/work/dashboard/certs&quot; 
    scp tls.* root@${
   
     master_ip}:/opt/k8s/work/dashboard/certs/
  done
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h4 id="_2-修改-dashboard-配置"><a href="#_2-修改-dashboard-配置" class="header-anchor">#</a> 2）修改 Dashboard 配置</h4> <p>手动创建 Secret</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>[root@master01 ~]# kubectl create namespace kubernetes-dashboard
[root@master01 ~]# kubectl create secret generic kubernetes-dashboard-certs --from-file=/opt/k8s/work/dashboard/certs -n kubernetes-dashboard
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>修改Dashboard 配置（你们可以通过这个地址来看 Dashboard 的 <code>yaml</code> 文件：传送门）</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>[root@k8s-master01 work]# cd dashboard/
[root@k8s-master01 dashboard]# vim dashboard.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  labels:
    k8s-app: kubernetes-dashboard
  name: kubernetes-dashboard
  namespace: kubernetes-dashboard
---
kind: Service
apiVersion: v1
metadata:
  labels:
    k8s-app: kubernetes-dashboard
  name: kubernetes-dashboard
  namespace: kubernetes-dashboard
spec:
  type: NodePort
  ports:
    - port: 443
      targetPort: 8443
      nodePort: 30080
  selector:
    k8s-app: kubernetes-dashboard
---
apiVersion: v1
kind: Secret
metadata:
  labels:
    k8s-app: kubernetes-dashboard
  name: kubernetes-dashboard-csrf
  namespace: kubernetes-dashboard
type: Opaque
data:
  csrf: &quot;&quot;
---
apiVersion: v1
kind: Secret
metadata:
  labels:
    k8s-app: kubernetes-dashboard
  name: kubernetes-dashboard-key-holder
  namespace: kubernetes-dashboard
type: Opaque
---
kind: ConfigMap
apiVersion: v1
metadata:
  labels:
    k8s-app: kubernetes-dashboard
  name: kubernetes-dashboard-settings
  namespace: kubernetes-dashboard
---
kind: Role
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  labels:
    k8s-app: kubernetes-dashboard
  name: kubernetes-dashboard
  namespace: kubernetes-dashboard
rules:
  - apiGroups: [&quot;&quot;]
    resources: [&quot;secrets&quot;]
    resourceNames: [&quot;kubernetes-dashboard-key-holder&quot;, &quot;kubernetes-dashboard-certs&quot;, &quot;kubernetes-dashboard-csrf&quot;]
    verbs: [&quot;get&quot;, &quot;update&quot;, &quot;delete&quot;]
  - apiGroups: [&quot;&quot;]
    resources: [&quot;configmaps&quot;]
    resourceNames: [&quot;kubernetes-dashboard-settings&quot;]
    verbs: [&quot;get&quot;, &quot;update&quot;]
  - apiGroups: [&quot;&quot;]
    resources: [&quot;services&quot;]
    resourceNames: [&quot;heapster&quot;, &quot;dashboard-metrics-scraper&quot;]
    verbs: [&quot;proxy&quot;]
  - apiGroups: [&quot;&quot;]
    resources: [&quot;services/proxy&quot;]
    resourceNames: [&quot;heapster&quot;, &quot;http:heapster:&quot;, &quot;https:heapster:&quot;, &quot;dashboard-metrics-scraper&quot;, &quot;http:dashboard-metrics-scraper&quot;]
    verbs: [&quot;get&quot;]
---
kind: ClusterRole
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  labels:
    k8s-app: kubernetes-dashboard
  name: kubernetes-dashboard
rules:
  # Allow Metrics Scraper to get metrics from the Metrics server
  - apiGroups: [&quot;metrics.k8s.io&quot;]
    resources: [&quot;pods&quot;, &quot;nodes&quot;]
    verbs: [&quot;get&quot;, &quot;list&quot;, &quot;watch&quot;]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  labels:
    k8s-app: kubernetes-dashboard
  name: kubernetes-dashboard
  namespace: kubernetes-dashboard
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: kubernetes-dashboard
subjects:
  - kind: ServiceAccount
    name: kubernetes-dashboard
    namespace: kubernetes-dashboard
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: kubernetes-dashboard
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: kubernetes-dashboard
subjects:
  - kind: ServiceAccount
    name: kubernetes-dashboard
    namespace: kubernetes-dashboard
---
kind: Deployment
apiVersion: apps/v1
metadata:
  labels:
    k8s-app: kubernetes-dashboard
  name: kubernetes-dashboard
  namespace: kubernetes-dashboard
spec:
  replicas: 1
  revisionHistoryLimit: 10
  selector:
    matchLabels:
      k8s-app: kubernetes-dashboard
  template:
    metadata:
      labels:
        k8s-app: kubernetes-dashboard
    spec:
      containers:
        - name: kubernetes-dashboard
          image: kubernetesui/dashboard:v2.0.0-beta8
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 8443
              protocol: TCP
          args:
            - --auto-generate-certificates
            - --namespace=kubernetes-dashboard
            - --tls-key-file=tls.key
            - --tls-cert-file=tls.crt
            - --token-ttl=3600
          volumeMounts:
            - name: kubernetes-dashboard-certs
              mountPath: /certs
            - mountPath: /tmp
              name: tmp-volume
          livenessProbe:
            httpGet:
              scheme: HTTPS
              path: /
              port: 8443
            initialDelaySeconds: 30
            timeoutSeconds: 30
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            runAsUser: 1001
            runAsGroup: 2001
      volumes:
        - name: kubernetes-dashboard-certs
          secret:
            secretName: kubernetes-dashboard-certs
        - name: tmp-volume
          emptyDir: {
   
     }
      serviceAccountName: kubernetes-dashboard
      nodeSelector:
        &quot;beta.kubernetes.io/os&quot;: linux
      tolerations:
        - key: node-role.kubernetes.io/master
          effect: NoSchedule
---
kind: Service
apiVersion: v1
metadata:
  labels:
    k8s-app: dashboard-metrics-scraper
  name: dashboard-metrics-scraper
  namespace: kubernetes-dashboard
spec:
  ports:
    - port: 8000
      targetPort: 8000
  selector:
    k8s-app: dashboard-metrics-scraper
---
kind: Deployment
apiVersion: apps/v1
metadata:
  labels:
    k8s-app: dashboard-metrics-scraper
  name: dashboard-metrics-scraper
  namespace: kubernetes-dashboard
spec:
  replicas: 1
  revisionHistoryLimit: 10
  selector:
    matchLabels:
      k8s-app: dashboard-metrics-scraper
  template:
    metadata:
      labels:
        k8s-app: dashboard-metrics-scraper
      annotations:
        seccomp.security.alpha.kubernetes.io/pod: 'runtime/default'
    spec:
      containers:
        - name: dashboard-metrics-scraper
          image: kubernetesui/metrics-scraper:v1.0.1
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 8000
              protocol: TCP
          livenessProbe:
            httpGet:
              scheme: HTTP
              path: /
              port: 8000
            initialDelaySeconds: 30
            timeoutSeconds: 30
          volumeMounts:
          - mountPath: /tmp
            name: tmp-volume
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            runAsUser: 1001
            runAsGroup: 2001
      serviceAccountName: kubernetes-dashboard
      nodeSelector:
        &quot;beta.kubernetes.io/os&quot;: linux
      tolerations:
        - key: node-role.kubernetes.io/master
          effect: NoSchedule
      volumes:
        - name: tmp-volume
          emptyDir: {
   
     }
[root@k8s-master01 dashboard]# kubectl create -f dashboard.yaml          
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br><span class="line-number">197</span><br><span class="line-number">198</span><br><span class="line-number">199</span><br><span class="line-number">200</span><br><span class="line-number">201</span><br><span class="line-number">202</span><br><span class="line-number">203</span><br><span class="line-number">204</span><br><span class="line-number">205</span><br><span class="line-number">206</span><br><span class="line-number">207</span><br><span class="line-number">208</span><br><span class="line-number">209</span><br><span class="line-number">210</span><br><span class="line-number">211</span><br><span class="line-number">212</span><br><span class="line-number">213</span><br><span class="line-number">214</span><br><span class="line-number">215</span><br><span class="line-number">216</span><br><span class="line-number">217</span><br><span class="line-number">218</span><br><span class="line-number">219</span><br><span class="line-number">220</span><br><span class="line-number">221</span><br><span class="line-number">222</span><br><span class="line-number">223</span><br><span class="line-number">224</span><br><span class="line-number">225</span><br><span class="line-number">226</span><br><span class="line-number">227</span><br><span class="line-number">228</span><br><span class="line-number">229</span><br><span class="line-number">230</span><br><span class="line-number">231</span><br><span class="line-number">232</span><br><span class="line-number">233</span><br><span class="line-number">234</span><br><span class="line-number">235</span><br><span class="line-number">236</span><br><span class="line-number">237</span><br><span class="line-number">238</span><br><span class="line-number">239</span><br><span class="line-number">240</span><br><span class="line-number">241</span><br><span class="line-number">242</span><br><span class="line-number">243</span><br><span class="line-number">244</span><br><span class="line-number">245</span><br><span class="line-number">246</span><br><span class="line-number">247</span><br><span class="line-number">248</span><br><span class="line-number">249</span><br><span class="line-number">250</span><br><span class="line-number">251</span><br></div></div><p>创建管理员账户</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>[root@k8s-master01 dashboard]# kubectl create serviceaccount admin-user -n kubernetes-dashboard
[root@k8s-master01 dashboard]# kubectl create clusterrolebinding admin-user --clusterrole=cluster-admin --serviceaccount=kubernetes-dashboard:admin-user
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h4 id="_3-验证-2"><a href="#_3-验证-2" class="header-anchor">#</a> 3）验证</h4> <p>获取登录令牌</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>[root@k8s-master01 dashboard]# kubectl -n kubernetes-dashboard describe secret $(kubectl -n kubernetes-dashboard get secret | grep admin-user | awk '{print $1}')
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h3x2emyimmj20u00ag78r.jpg" alt="图片">
访问：<code>https://192.168.1.1:30080</code> <img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h3x2eqousxj20u00e1tb2.jpg" alt="图片"> <img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h3x2eovl0mj20u00g3wgt.jpg" alt="图片">
到此，我们的 Kubernetes 便搭建完成了，如果你们在安装中出现问题，可以通过下面的推广信息来联系博主共同探讨。</p></div> <footer class="page-edit" style="display:none;"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">7/6/2022, 1:31:01 PM</span></div></footer> <!----> <!----></main> <!----> <div class="comments-wrapper" data-v-4698c43e><!----></div></div></div></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-44bd5a18 data-v-44bd5a18><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-44bd5a18><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-44bd5a18></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-44bd5a18></path></svg></div><!----><div></div><!----><div class="reco-bgm-panel" data-v-b1d3339e><audio id="bgm" src="https://music.163.com/song/media/outer/url?id=1480361161.mp3" data-v-b1d3339e></audio> <div class="reco-float-box" style="bottom:200px;z-index:999999;display:none;" data-v-b1d3339e data-v-41bcba48 data-v-b1d3339e><img src="https://p2.music.126.net/qOOTIykbSLw9RHB0vI83GA==/737772302281958.jpg" data-v-b1d3339e></div> <div class="reco-bgm-box" style="left:10px;bottom:10px;z-index:999999;" data-v-b1d3339e data-v-41bcba48 data-v-b1d3339e><div class="reco-bgm-cover" style="background-image:url(https://p2.music.126.net/qOOTIykbSLw9RHB0vI83GA==/737772302281958.jpg);" data-v-b1d3339e><div class="mini-operation" style="display:none;" data-v-b1d3339e><i class="reco-bgm reco-bgm-pause" style="display:none;" data-v-b1d3339e></i> <i class="reco-bgm reco-bgm-play" style="display:none;" data-v-b1d3339e></i></div> <div class="falut-message" style="display:none;" data-v-b1d3339e>
          播放失败
        </div></div> <div class="reco-bgm-info" data-v-b1d3339e data-v-41bcba48 data-v-b1d3339e><div class="info-box" data-v-b1d3339e><i class="reco-bgm reco-bgm-music music" data-v-b1d3339e></i>囧架架</div> <div class="info-box" data-v-b1d3339e><i class="reco-bgm reco-bgm-artist" data-v-b1d3339e></i>十三叔</div> <div class="reco-bgm-progress" data-v-b1d3339e><div class="progress-bar" data-v-b1d3339e><div class="bar" data-v-b1d3339e></div></div></div> <div class="reco-bgm-operation" data-v-b1d3339e><i class="reco-bgm reco-bgm-last last" data-v-b1d3339e></i> <i class="reco-bgm reco-bgm-pause pause" style="display:none;" data-v-b1d3339e></i> <i class="reco-bgm reco-bgm-play play" data-v-b1d3339e></i> <i class="reco-bgm reco-bgm-next next" data-v-b1d3339e></i> <i class="reco-bgm reco-bgm-volume1 volume" data-v-b1d3339e></i> <i class="reco-bgm reco-bgm-mute mute" style="display:none;" data-v-b1d3339e></i> <div class="volume-bar" data-v-b1d3339e><div class="bar" data-v-b1d3339e></div></div></div></div> <div class="reco-bgm-left-box" data-v-b1d3339e data-v-41bcba48 data-v-b1d3339e><i class="reco-bgm reco-bgm-left" data-v-b1d3339e></i></div></div></div></div></div>
    <script src="/assets/js/app.d0f5f29d.js" defer></script><script src="/assets/js/4.14868eff.js" defer></script><script src="/assets/js/1.4ea549be.js" defer></script><script src="/assets/js/135.90f2f6ba.js" defer></script><script src="/assets/js/11.fc56e899.js" defer></script>
  </body>
</html>
